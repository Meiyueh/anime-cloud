<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>Profil ‚Ä¢ AnimeCloud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles/main.css" />
  <style>
    .container{max-width:820px;margin:24px auto;padding:0 16px}
    .cover{display:flex;gap:16px;align-items:center}
    .profile-avatar{background:var(--border);width:96px;height:96px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;color:var(--brand);flex-shrink:0;overflow:hidden;border:1px solid var(--border)}
    .profile-avatar img{width:100%;height:100%;object-fit:cover}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    .muted{color:var(--muted)}
    .msg{margin-top:12px}
    .hidden{display:none !important}
    .section-title{margin-top:1rem;font-size:1.1rem;font-weight:600;border-bottom:1px solid var(--border);padding-bottom:.3rem;margin-bottom:.8rem}
    .section-anime{margin-top:.6rem;font-weight:600}
    /* jednoduch√° m≈ô√≠≈æka pro karty (spolehne se hlavnƒõ na tvoje .card .anime-card styly) */
    .cards-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width:900px){ .cards-grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media (max-width:560px){ .cards-grid{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="/index.html" class="brand"><img src="/assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="/index.html">Info</a>
      <a href="/upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="/feedback.html" id="nav-feedback" class="hidden">Feedback</a>
      <a href="/account.html" id="nav-account" class="hidden">√öƒçet</a>
      <a href="/login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="/admin.html" id="nav-admin" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <div class="card">
      <div class="cover">
        <div class="profile-avatar">
          <img id="pfp" alt="avatar" class="hidden" />
          <span id="pfp-fb">üë§</span>
        </div>
        <div>
          <h2 id="name">‚Äî</h2>
          <div class="badges">
            <span id="badge-primary" class="badge primary hidden"></span>
            <span id="badge-secondary" class="badge hidden"></span>
          </div>
          <div class="muted">
            <span id="slug">@‚Äî</span> ‚Ä¢ <span id="joined">ƒålenem od ‚Äî</span>
          </div>
        </div>
      </div>

      <p id="privNote" class="msg hidden">üîí Tento profil je soukrom√Ω. Vlastn√≠k zat√≠m nesd√≠l√≠ sv√© informace ve≈ôejnƒõ.</p>
      <p id="linkNote" class="msg hidden">üîó Tento profil je p≈ô√≠stupn√Ω jen p≈ôes odkaz.</p>
      <p id="notFound" class="msg hidden">‚ùå U≈æivatel nenalezen.</p>

      <div class="section-title">Viditelnost profilu</div>
      <!-- pod t√≠mto nadpisem budou badge a seznam top 3 anime -->
      <div id="visBadges" class="badges" style="margin-bottom:.5rem">
        <!-- badge-primary (viditelnost) a badge-secondary (titul) u≈æ jsou naho≈ôe a jen se zviditeln√≠ -->
      </div>

      <div class="section-anime">Uploadovan√© Anime</div>
      <div id="top-anime" class="cards-grid"></div>
      <p id="noUploads" class="muted hidden" style="margin-top:.25rem">≈Ω√°dn√© nahr√°vky zat√≠m nejsou.</p>
    </div>
  </main>

  <footer class="site-footer"><small>Ve≈ôejn√Ω profil ‚Ä¢ AnimeCloud</small></footer>

  <script src="/scripts/app.js"></script>
  <script>
    App.initNavbar();

    // --- helpers ---
    const el = id => document.getElementById(id);
    const show = (id, on=true)=>{ const x=el(id); if(!x) return; x.classList[on?'remove':'add']('hidden'); };
    const ddmmyyyy = iso=>{
      if(!iso) return '‚Äî';
      const d = new Date(iso);
      return String(d.getDate()).padStart(2,'0')+'.'+String(d.getMonth()+1).padStart(2,'0')+'.'+d.getFullYear();
    };

    // slug z /u/<slug>
    const rawPath = (location.pathname || '');
    const userSlug = decodeURIComponent((rawPath.split('/u/')[1] || '').split(/[?#]/)[0] || '').trim();

    // odhad emailu z avatar_url (private/avatars/<email>.<ext>)
    function guessEmailFromAvatar(url){
      try{
        if(!url) return null;
        const path = new URL(url, location.origin).pathname; // i pro absolutn√≠ GCS url
        const m = path.match(/\/private\/avatars\/([^\/.]+)\.[a-z0-9]+$/i);
        if(!m) return null;
        return decodeURIComponent(m[1]).replace('%40','@');
      }catch{ return null; }
    }

    // heuristika pro vytƒõ≈æen√≠ mapy u≈æivatel‚Üíslugy z /uploads/counts
    function extractUserMapFromCounts(counts){
      // pokus 1: counts.by_user[email][slug] = X
      if(counts && counts.by_user && typeof counts.by_user === 'object'){
        return counts.by_user;
      }
      // pokus 2: counts.users[email][slug] = X
      if(counts && counts.users && typeof counts.users === 'object'){
        return counts.users;
      }
      // pokus 3: counts[slug].users[email] = X
      const map = {};
      if(counts && typeof counts === 'object'){
        for(const [slug, obj] of Object.entries(counts)){
          if(obj && obj.users && typeof obj.users === 'object'){
            for(const [email, n] of Object.entries(obj.users)){
              if(!map[email]) map[email] = {};
              map[email][slug] = n;
            }
          }
        }
        if(Object.keys(map).length) return map;
      }
      return {};
    }

    // z√≠sk√°n√≠ total poƒçt≈Ø pro Y
    function extractTotalsFromCounts(counts){
      // pokus 1: counts.total[slug] = Y
      if(counts && counts.total && typeof counts.total === 'object'){
        return counts.total;
      }
      // pokus 2: counts[slug].total = Y
      const t = {};
      if(counts && typeof counts === 'object'){
        for(const [slug, obj] of Object.entries(counts)){
          if(obj && typeof obj.total === 'number'){ t[slug] = obj.total; }
          else if(typeof obj === 'number'){ t[slug] = obj; }
        }
      }
      return t;
    }

    // naƒçti anime metadata
    async function loadAnimeMeta(){
      try{
        const r = await fetch('/data/anime.json');
        const j = await r.json();
        const meta = {};
        if(Array.isArray(j)){
          j.forEach(a=>{
            const slug = a.slug || a.id || a.code;
            if(!slug) return;
            meta[slug] = {
              title: a.title || a.name || slug,
              cover: a.cover_url || a.cover || null
            };
          });
        }else if(j && j.anime && Array.isArray(j.anime)){
          j.anime.forEach(a=>{
            const slug = a.slug || a.id || a.code;
            if(!slug) return;
            meta[slug] = {
              title: a.title || a.name || slug,
              cover: a.cover_url || a.cover || null
            };
          });
        }
        return meta;
      }catch{ return {}; }
    }

    function coverUrlFor(slug, metaCover){
      if(metaCover) return metaCover;
      // fallback na standardn√≠ um√≠stƒõn√≠ v bucketu (jpg), onerror spadne na logo
      return `https://storage.googleapis.com/anime-cloud/covers/${encodeURIComponent(slug)}.jpg`;
    }

    function buildAnimeCard(slug, title, x, y, cover){
      const a = document.createElement('a');
      a.href = '#';
      a.className = 'card anime-card';
      a.dataset.slug = slug;
      a.innerHTML = `
        <img class="cover-tall" loading="lazy"
             src="${cover}"
             alt="${title.replace(/"/g,'&quot;')}"
             onerror="this.src='assets/logo.svg'">
        <div class="anime-title">${title}</div>
        <div class="xxxxx">Poƒçet nahran√Ωch vide√≠ u≈æivatelem ${x}/${(y ?? '?')}</div>
      `;
      return a;
    }

    async function loadTop3Uploads(viewerProfile){
      // respektuj soukrom√≠
      const vis = (viewerProfile.visibility || 'private').toLowerCase();
      const isPrivate = vis === 'private';
      if(isPrivate){
        show('privNote', true);
        show('noUploads', true);
        return;
      }else if(vis === 'link'){
        show('linkNote', true);
      }

      // odhad emailu (kv≈Øli filtrov√°n√≠ v counts)
      const email = guessEmailFromAvatar(viewerProfile.avatar_url) || null;

      // naƒçten√≠ poƒçt≈Ø a metadat
      let counts = {};
      try{
        const rc = await fetch('/uploads/counts');
        counts = await rc.json();
      }catch{}

      const byUser = extractUserMapFromCounts(counts);
      const totals = extractTotalsFromCounts(counts);

      const perAnime = (email && byUser[email]) ? byUser[email] : null;
      if(!perAnime || !Object.keys(perAnime).length){
        show('noUploads', true);
        return;
      }

      // se≈ôadit podle X (desc) a st√°hnout meta
      const meta = await loadAnimeMeta();
      const top3 = Object.entries(perAnime)
        .map(([slug, x])=>({ slug, x: Number(x)||0, y: (typeof totals[slug]==='number'? totals[slug] : null) }))
        .filter(e=>e.x>0)
        .sort((a,b)=> b.x - a.x)
        .slice(0,3);

      if(!top3.length){
        show('noUploads', true);
        return;
      }

      const wrap = el('top-anime');
      wrap.innerHTML = '';
      top3.forEach(entry=>{
        const title = (meta[entry.slug]?.title) || entry.slug;
        const cover = coverUrlFor(entry.slug, meta[entry.slug]?.cover || null);
        wrap.appendChild(buildAnimeCard(entry.slug, title, entry.x, entry.y, cover));
      });
    }

    async function loadProfile(){
      if(!userSlug){ show('notFound', true); return; }
      try{
        const r = await fetch('/api/profile/'+encodeURIComponent(userSlug));
        const j = await r.json().catch(()=> ({}));
        if(!r.ok || !j?.ok || !j?.profile){ throw new Error('user not found'); }

        const p = j.profile;

        // Jm√©no / slug
        el('name').textContent = p.display_name || p.slug || 'U≈æivatel';
        el('slug').textContent = '@' + (p.slug || userSlug);
        el('joined').textContent = 'ƒålenem od ' + ddmmyyyy(p.joined_at);

        // Avatar + fallback p√≠smeno
        const img = el('pfp'), fb = el('pfp-fb');
        if(p.avatar_url){
          img.src = p.avatar_url + '?ts=' + Date.now();
          img.onload = ()=>{ show('pfp', true); show('pfp-fb', false); };
          img.onerror= ()=>{ show('pfp', false); fb.textContent = (String(p.display_name||p.slug||'?')[0]||'?').toUpperCase(); show('pfp-fb', true); };
        }else{
          show('pfp', false);
          fb.textContent = (String(p.display_name||p.slug||'?')[0]||'?').toUpperCase();
          show('pfp-fb', true);
        }

        // Badge-primary = viditelnost
        const visTxt = (p.visibility||'private').toLowerCase()==='public' ? 'Ve≈ôejn√Ω'
                      : (p.visibility||'').toLowerCase()==='link' ? 'Jen p≈ôes odkaz'
                      : 'Soukrom√Ω';
        el('badge-primary').textContent = visTxt;
        show('badge-primary', true);

        // Badge-secondary = prvn√≠ titul (pokud je)
        const t = Array.isArray(p.titles) ? (p.titles[0]||'') : '';
        if(t){ el('badge-secondary').textContent = t; show('badge-secondary', true); }
        else { show('badge-secondary', false); }

        // zviditelni ≈ô√°dek badge i pod ‚ÄûViditelnost profilu‚Äú
        show('visBadges', true);

        // Top 3 uploads
        await loadTop3Uploads(p);

      }catch(e){
        show('notFound', true);
      }
    }

    loadProfile();
  </script>
</body>
</html>
