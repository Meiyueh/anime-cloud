<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî P≈ôihl√°≈°en√≠</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    .panel-auth{max-width:480px;margin:0 auto;}
    .panel-auth form{display:flex;flex-direction:column;gap:.8rem;align-items:center;text-align:center}
    .panel-auth .row{width:100%;align-items:center}
    .panel-auth label{width:100%;text-align:center}
    .panel-auth input{width:75% !important;min-width:220px;text-align:center}
    .panel-auth .row.align-right,.panel-auth .row .w-compact-sm{display:flex;justify-content:center}
    .link-swap{display:block;text-align:center;margin-top:.5rem}
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="brand"><img src="assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="index.html">Info</a>
      <a href="upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="feedback.html" id="nav-feedback" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login" aria-current="page">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1 style="text-align:center;">P≈ôihl√°≈°en√≠ / Registrace</h1>

    <!-- LOGIN -->
    <div class="card panel-auth" id="panel-login">
      <form id="loginForm" class="compact">
        <div class="row compact">
          <label for="loginEmail">E-mail</label>
          <input type="email" id="loginEmail" required />
        </div>
        <div class="row compact">
          <label for="loginPass">Heslo</label>
          <input type="password" id="loginPass" required />
        </div>
        <div class="row align-right">
          <button type="submit" class="w-compact-sm">P≈ôihl√°sit</button>
        </div>
      </form>
      <a href="#" class="link-swap" id="link-show-register">Nem√°te √∫ƒçet? Zaregistrujte se</a>
    </div>

    <!-- REGISTER -->
    <div class="card panel-auth hidden" id="panel-register">
      <form id="registerForm" class="compact">
        <div class="row compact">
          <label for="regEmail">E-mail</label>
          <input type="email" id="regEmail" required />
        </div>
        <div class="row compact">
          <label for="regPass1">Heslo</label>
          <input type="password" id="regPass1" required />
        </div>
        <div class="row compact">
          <label for="regPass2">Potvrzen√≠ hesla</label>
          <input type="password" id="regPass2" required />
        </div>
        <div class="row align-right">
          <button type="submit" class="w-compact-sm">Registrovat</button>
        </div>
      </form>
      <a href="#" class="link-swap" id="link-show-login">M√°te √∫ƒçet? P≈ôihlaste se</a>
    </div>

    <p id="loginMsg" class="msg" style="text-align:center;"></p>
  </main>

  <footer class="site-footer"><small>AnimeCloud ‚Ä¢ P≈ôihl√°≈°en√≠</small></footer>

  <script src="scripts/app.js"></script>
  <script>
    App.initNavbar();

    const msg = document.getElementById('loginMsg');
    const panelLogin = document.getElementById('panel-login');
    const panelRegister = document.getElementById('panel-register');

    // p≈ôep√≠n√°n√≠ panel≈Ø
    document.getElementById('link-show-register').addEventListener('click', e => {
      e.preventDefault();
      panelLogin.classList.add('hidden');
      panelRegister.classList.remove('hidden');
      msg.textContent='';
    });
    document.getElementById('link-show-login').addEventListener('click', e => {
      e.preventDefault();
      panelRegister.classList.add('hidden');
      panelLogin.classList.remove('hidden');
      msg.textContent='';
    });

    // LOGIN -> /auth/login
  document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPass').value.trim();
      if (!email || !password) return App.showMsg(msg, 'Vypl≈àte e-mail i heslo.', 'error');
  
      try{
        const r = await fetch(App.api('/auth/login'), {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, password })
        });
        const payload = await r.json().catch(()=> ({}));
  
        if (!r.ok || !payload?.ok) {
          const err = payload?.error || ('HTTP '+r.status);
          if (err === 'not_verified') {
            return App.showMsg(msg, '√öƒçet je≈°tƒõ nen√≠ ovƒõ≈ôen. Zkontrolujte e-mail.', 'error');
          }
          return App.showMsg(msg, 'P≈ôihl√°≈°en√≠ selhalo: ' + err, 'error');
        }
  
        // robustn√≠ normalizace odpovƒõdi
        const userObj = payload.user || {
          email: payload.email,
          role:  payload.role || 'user',
          name:  payload.name || ''
        };
        if (!userObj?.email) {
          return App.showMsg(msg, 'Server neposlal e-mail v odpovƒõdi (≈°patn√Ω form√°t).', 'error');
        }
  
        const authObj = {
          email: userObj.email,
          role: userObj.role || 'user',
          token: payload.token || null,
          at: Date.now()
        };
        localStorage.setItem('animecloud_auth', JSON.stringify(authObj));
  
        App.toast('P≈ôihl√°≈°eno', 'ok');
        location.href='index.html';
      } catch(err){
        console.error(err);
        App.showMsg(msg, 'Chyba p≈ôipojen√≠.', 'error');
      }
    });
    // REGISTER -> /auth/register (pos√≠l√°me password i password2)
    document.getElementById('registerForm').addEventListener('submit', async e => {
      e.preventDefault();
      const email = document.getElementById('regEmail').value.trim();
      const p1 = document.getElementById('regPass1').value.trim();
      const p2 = document.getElementById('regPass2').value.trim();
      if (!email || !p1 || !p2) return App.showMsg(msg,'Vypl≈àte v≈°echna pole.','error');
      if (p1.length < 8) return App.showMsg(msg,'Heslo mus√≠ m√≠t alespo≈à 8 znak≈Ø.','error');
      if (p1 !== p2) return App.showMsg(msg,'Hesla se neshoduj√≠.','error');

      try{
        const r = await fetch(App.api('/auth/register'), {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, password: p1, password2: p2 })
        });
        const payload = await r.json().catch(()=> ({}));
        if (!r.ok || !payload?.ok) {
          const err = payload?.error || ('HTTP '+r.status);
          if (r.status === 409) return App.showMsg(msg,'√öƒçet pro tento e-mail u≈æ existuje.','error');
          return App.showMsg(msg, 'Registrace selhala: ' + err, 'error');
        }
        App.showMsg(msg, '‚úÖ Registrace probƒõhla. Zkontrolujte e-mail a potvrƒète √∫ƒçet.', 'ok');
        panelRegister.classList.add('hidden');
        panelLogin.classList.remove('hidden');
        document.getElementById('loginEmail').value = email;
        document.getElementById('loginPass').focus();
      } catch {
        App.showMsg(msg, 'Chyba p≈ôipojen√≠.', 'error');
      }
    });
  </script>
</body>
</html>


