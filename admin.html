<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    details>summary{cursor:pointer;list-style:none;user-select:none;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--panel);margin:8px 0}
    details[open]>summary{background:#191932}
    .tree{margin-left:16px}
    .small{font-size:.92rem;color:var(--muted)}
    .btn{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:#0f0f1d;color:var(--text);cursor:pointer}
    .btn.danger{background:var(--err);border-color:#a3211a}
    .btn.inline{margin-left:8px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:.85rem;color:var(--muted)}
    ul.list-simple{list-style:none;padding-left:0} ul.list-simple li{margin:4px 0}
    .dash-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .flex-between{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .tree details{ max-width: 760px; margin-left: auto; }
    .tickets .controls{display:flex;align-items:center;gap:8px;}
    .tickets .controls-left{display:flex;align-items:center;gap:8px;justify-content:flex-start;}
    .tickets .controls-right{margin-left:auto;display:flex;align-items:center;}
    .tickets select{width:auto;min-width:160px;text-align-last:left;min-height:36px;}
    #addAnimePanel input, #addAnimePanel select, #addAnimePanel textarea { padding:.65rem .7rem; }
    .req { color:#c62828; margin-left:4px; font-weight:700; }
    .filters-left{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .filters-right{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-left:auto; }
    .filters .w-compact-sm{ width:auto !important; min-width:160px; max-width:240px; }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="brand"><img src="assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="index.html">Info</a>
      <a href="upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="feedback.html" id="nav-feedback" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" aria-current="page" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1>Administrace</h1>

    <div id="guard" class="card" style="display:none">
      <p>Nem√°≈° opr√°vnƒõn√≠. P≈ôihlas se jako <code>admin@localanim</code>.</p>
    </div>

    <div id="content" style="display:none">
      <div class="card" id="dash"></div>

      <div class="card" id="uploadsCard">
        <div class="flex-between" style="margin-bottom:8px;">
          <h2>Seznam nahr√°vek</h2>
          <div class="actions-top" style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="btnAddAnime" class="btn">P≈ôidat anime</button>
          </div>
        </div>

        <div class="filters" style="margin-bottom:8px;">
          <div class="filters-left">
            <input id="fSearch" class="w-compact-sm" type="text" placeholder="Hledat anime." />
            <select id="fQual" class="w-compact-sm">
              <option value="">‚Äî kvalita ‚Äî</option><option>480p</option><option>720p</option><option>1080p</option><option>2160p</option>
            </select>
          </div>
        </div>

        <div id="treeWrap" class="tree"></div>
      </div>

      <!-- Panel: P≈ôidat anime -->
      <div id="addAnimePanel" class="card" style="display:none; margin-top:12px;">
        <div class="flex-between"><h2>P≈ôidat anime</h2><button id="btnCloseAddAnime" class="btn">Zav≈ô√≠t</button></div>
        <form id="addAnimeForm" class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
          <div class="row">
            <label>Slug <span class="req">*</span></label>
            <input id="anSlug" type="text" required placeholder="nap≈ô. bleach">
          </div>

          <div class="row">
            <label>N√°zev <span class="req">*</span></label>
            <input id="anTitle" type="text" required placeholder="nap≈ô. Bleach">
          </div>

          <div class="row">
            <label>Poƒçet d√≠l≈Ø <span class="req">*</span></label>
            <input id="anEpisodes" class="tall" type="number" min="1" required placeholder="nap≈ô. 366">
          </div>

          <div class="row">
            <label>Rok <span class="req">*</span></label>
            <input id="anYear" class="tall" type="number" min="1900" max="2100" required placeholder="nap≈ô. 2004">
          </div>

          <div class="row" style="grid-column:1 / -1;">
            <label>≈Ω√°nry (ƒç√°rkou) <span class="req">*</span></label>
            <input id="anGenres" type="text" required placeholder="nap≈ô. Action, Shounen">
          </div>

          <div class="row" style="grid-column:1 / -1;">
            <label>Popis <span class="req">*</span></label>
            <textarea id="anDesc" rows="4" required placeholder="popis‚Ä¶"></textarea>
          </div>

          <div class="row">
            <label>Cover (obr√°zek) <span class="req">*</span></label>
            <input id="anCoverFile" type="file" accept="image/*" required>
            <small class="muted">Doporuƒçeno ~600√ó900.</small>
            <img id="anCoverPreview" alt="" style="display:none; max-width:160px; border-radius:8px; margin-top:6px; border:1px solid var(--border);">
          </div>

          <div class="row">
            <label>Studio <span class="req">*</span></label>
            <input id="anStudio" type="text" required>
          </div>

          <div class="row">
            <label>Status <span class="req">*</span></label>
            <select id="anStatus" required>
              <option value="ongoing">ongoing</option>
              <option value="completed">completed</option>
              <option value="hiatus">hiatus</option>
            </select>
          </div>

          <div class="row" style="grid-column:1 / -1; display:flex; justify-content:flex-end;">
            <button type="submit" class="btn">Ulo≈æit</button>
          </div>
          <p id="addAnimeMsg" class="msg" style="grid-column:1 / -1;"></p>
        </form>
      </div>

      <!-- Panel: Tikety -->
      <div id="ticketsPanel" class="card tickets" style="display:none">
        <div class="flex-between"><h2>Tikety u≈æivatel≈Ø</h2><button id="btnCloseTickets" class="btn">Zav≈ô√≠t</button></div>
        <div id="ticketsList"></div>
      </div>
    </div>
  </main>

  <footer class="site-footer"><small>Admin ‚Ä¢ AnimeCloud</small></footer>

  <script src="scripts/app.js"></script>
  <script>
    window.CLOUD_BASE = "https://storage.googleapis.com/anime-cloud";
    App.initNavbar();

    if (!App.isAdmin()){
      document.getElementById('guard').style.display='block';
    } else {
      document.getElementById('content').style.display='block';
      initAdmin();
    }

    async function apiGet(path){ const r = await App.apiFetch(path); return await r.json(); }
    async function apiPost(path, body){ const r = await App.apiFetch(path, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)}); return await r.json(); }

    async function initAdmin(){
      // DASH ze /stats
      try {
        const st = await apiGet('/stats');
        document.getElementById('dash').innerHTML = `
          <h2>Dashboard</h2>
          <div class="dash-grid">
            <div class="card"><strong>Poƒçet ovƒõ≈ôen√Ωch u≈æivatel≈Ø</strong><div class="muted">${st.users_verified}</div></div>
            <div class="card"><strong>Celkem upload≈Ø (video)</strong><div class="muted">${st.uploads_total}</div></div>
            <div class="card"><strong>Nejaktivnƒõj≈°√≠ anime</strong><div class="muted">${st.top_anime?.slug || '‚Äî'} (${st.top_anime?.episodes || 0} ep)</div></div>
          </div>`;
      } catch(e){ /* ignore */ }

      // TREE z GCS
      const treeWrap = document.getElementById('treeWrap');
      const fSearch = document.getElementById('fSearch');
      const fQual = document.getElementById('fQual');

      const raw = await apiGet('/admin/uploads/tree');
      let tree = raw.tree || {};

      function buildTreeHTML(obj){
        const slugs = Object.keys(obj).sort();
        if (!slugs.length) return '<p class="muted">≈Ω√°dn√° data.</p>';
        return slugs.map(slug=>{
          const eps = obj[slug].episodes || {};
          const epHtml = Object.keys(eps).sort().map(ep=>{
            const quals = eps[ep];
            const qualHtml = ['480p','720p','1080p','2160p'].map(q=>{
              const arr = (quals[q]||[]).slice().sort((a,b)=> (b.updated||'').localeCompare(a.updated||''));
              const files = arr.map(u=>`
                <li>
                  <span class="code">${u.name}</span>
                  &nbsp;<span class="small">(${u.size} B)</span>
                </li>`).join('');
              return `<details><summary>${q==='2160p'?'4K (2160p)':q} <span class="small">(${arr.length})</span></summary><ul class="list-simple tree">${files||'<li class="small">≈Ω√°dn√° data</li>'}</ul></details>`;
            }).join('');
            return `<details><summary>D√≠l ${Number(ep)}</summary><div class="tree">${qualHtml}</div></details>`;
          }).join('');
          return `<details><summary>${slug}</summary><div class="tree">${epHtml||'<p class="small">≈Ω√°dn√© d√≠ly</p>'}</div></details>`;
        }).join('');
      }

      function applyFilters(){
        const q = (fSearch.value||'').toLowerCase();
        const qual = fQual.value;
        const filtered = {};
        for (const [slug, data] of Object.entries(tree)){
          if (q && !slug.toLowerCase().includes(q)) continue;
          const eps = {};
          for (const [ep, quals] of Object.entries(data.episodes||{})){
            const qmap = {};
            for (const [k, arr] of Object.entries(quals)){
              if (qual && k !== qual) continue;
              qmap[k] = arr;
            }
            if (Object.keys(qmap).length) eps[ep] = qmap;
          }
          if (Object.keys(eps).length) filtered[slug] = { episodes: eps, counts: data.counts };
        }
        treeWrap.innerHTML = buildTreeHTML(filtered);
      }
      [fSearch, fQual].forEach(el=> el.addEventListener('input', applyFilters));
      applyFilters();

      // Tikety
      const ticketsPanel = document.getElementById('ticketsPanel');
      const btnTickets = document.createElement('button');
      btnTickets.className='btn';
      btnTickets.textContent='Tikety';
      btnTickets.addEventListener('click', ()=>{ ticketsPanel.style.display='block'; renderTickets(); });
      document.querySelector('#uploadsCard .actions-top').appendChild(btnTickets);
      document.getElementById('btnCloseTickets').addEventListener('click', ()=> ticketsPanel.style.display='none');

      async function renderTickets(){
        const r = await apiGet('/feedback/list');
        const list = (r.items||[]).slice();
        const wrap = document.getElementById('ticketsList');
        if (!list.length){ wrap.innerHTML = '<p class="muted">≈Ω√°dn√© tikety.</p>'; return; }
        wrap.innerHTML = list.map(t => `
          <div class="ticket-card">
            <details data-id="${t.id}">
              <summary>[${t.category||'‚Äî'}] ${new Date(t.ts||Date.now()).toLocaleString()} ‚Äî ${t.user||t.name||'anonym'} ${t.priority?('‚Ä¢ '+t.priority):''} ‚Äî <span class="small">${t.status||'open'}</span></summary>
              <div class="thread">
                ${ (t.messages||[]).map(m => `
                  <div class="msgRow ${m.role==='admin'?'admin':''}">
                    <div>
                      <div class="bubble">${(m.text||'').replace(/</g,'&lt;')}</div>
                      <div class="meta">${m.author||m.role} ‚Ä¢ ${new Date(m.ts||Date.now()).toLocaleString()}</div>
                    </div>
                  </div>`).join('') }
              </div>
            </details>
          </div>`).join('');
      }

      // P≈ôidat anime (po≈°li cover jako dataURL)
      const addPanel = document.getElementById('addAnimePanel');
      document.getElementById('btnAddAnime').addEventListener('click', ()=> addPanel.style.display='block');
      document.getElementById('btnCloseAddAnime').addEventListener('click', ()=> addPanel.style.display='none');

      document.getElementById('addAnimeForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const slug  = document.getElementById('anSlug').value.trim().toLowerCase();
        const title = document.getElementById('anTitle').value.trim();
        const episodes = Number(document.getElementById('anEpisodes').value);
        const genres = document.getElementById('anGenres').value.split(',').map(s=>s.trim()).filter(Boolean);
        const description = document.getElementById('anDesc').value.trim();
        const coverFile = document.getElementById('anCoverFile').files[0];
        const status = document.getElementById('anStatus').value;
        const year = Number(document.getElementById('anYear').value);
        const studio = document.getElementById('anStudio').value.trim();
        const msgEl = document.getElementById('addAnimeMsg');

        if (!slug||!title||!episodes||!genres.length||!description||!coverFile||!status||!year||!studio){
          return App.showMsg(msgEl,'Vypl≈à v≈°echna pole.','error');
        }

        const cover = await new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.onload = ()=>resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(coverFile);
        });

        try{
          const resp = await App.apiFetch('/admin/add_anime', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ slug,title,episodes,genres,description,cover,status,year,studio })
          });
          const payload = await resp.json().catch(()=> ({}));
          if (!resp.ok || !payload.ok) throw new Error(payload.error || ('HTTP '+resp.status));
          const prev = document.getElementById('anCoverPreview'); prev.src = cover; prev.style.display='block';
          App.showMsg(msgEl,'‚úÖ Ulo≈æeno a zaps√°no do anime.json.','ok');
        } catch(err){
          App.showMsg(msgEl,'‚ö†Ô∏è Nepoda≈ôilo se ulo≈æit: ' + (err.message||err), 'error');
        }
      });
    }
  </script>
</body>
</html>
