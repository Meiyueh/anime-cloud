<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    details>summary{cursor:pointer;list-style:none;user-select:none;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--panel);margin:8px 0}
    details[open]>summary{background:#191932}
    .tree{margin-left:16px}
    .small{font-size:.92rem;color:var(--muted)}
    .btn{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:#0f0f1d;color:var(--text);cursor:pointer}
    .btn.danger{background:var(--err);border-color:#a3211a}
    .btn.inline{margin-left:8px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:.85rem;color:var(--muted)}
    ul.list-simple{list-style:none;padding-left:0} ul.list-simple li{margin:4px 0}
    .dash-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .flex-between{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}

    /* strom z√∫≈æit a p≈ôisunout doprava */
    .tree details{ max-width: 760px; margin-left: auto; }

    /* Tikety: rozlo≈æen√≠ dole (select vlevo, tlaƒç√≠tko vpravo) */
    .tickets .controls{display:flex;align-items:center;gap:8px;}
    .tickets .controls-left{display:flex;align-items:center;gap:8px;justify-content:flex-start;}
    .tickets .controls-right{margin-left:auto;display:flex;align-items:center;}
    .tickets select{width:auto;min-width:160px;text-align-last:left;min-height:36px;}

    /* P≈ôidat anime ‚Äì vƒõt≈°√≠ v√Ω≈°ka pol√≠ a hvƒõzdiƒçky povinn√Ωch pol√≠ */
    #addAnimePanel input[type="text"],
    #addAnimePanel input[type="number"],
    #addAnimePanel select,
    #addAnimePanel textarea {
      padding: .65rem .7rem;
    }
    .req { color:#c62828; margin-left:4px; font-weight:700; }

    /* Filtry: lev√°/prav√° ƒç√°st */
    .filters-left{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .filters-right{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-left:auto; }
    .filters .w-compact-sm{ width:auto !important; min-width:160px; max-width:240px; }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="brand"><img src="assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="index.html">Info</a>
      <a href="upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="feedback.html" id="nav-feedback" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" aria-current="page" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1>Administrace</h1>

    <div id="guard" class="card" style="display:none">
      <p>Nem√°≈° opr√°vnƒõn√≠. P≈ôihlas se jako <code>admin@localanim</code>.</p>
    </div>

    <div id="content" style="display:none">
      <div class="card" id="dash"></div>

      <div class="card" id="uploadsCard">
        <!-- horn√≠ ≈ô√°dek: n√°zev + akƒçn√≠ tlaƒç√≠tka -->
        <div class="flex-between" style="margin-bottom:8px;">
          <h2>Seznam nahr√°vek</h2>
          <div class="actions-top" style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="btnAddAnime" class="btn">P≈ôidat anime</button>
            <button id="btnExport" class="btn">Export JSON</button>
            <button id="btnTickets" class="btn">Tikety</button>
            <button id="btnClearLocal" class="btn">Vyƒçistit lok√°ln√≠ katalog</button>
            <button id="btnWipeAll" class="btn danger">Smazat v≈°e</button>
          </div>
        </div>

        <!-- druh√Ω ≈ô√°dek: filtry -->
        <div class="filters" style="margin-bottom:8px;">
          <div class="filters-left">
            <input id="fSearch" class="w-compact-sm" type="text" placeholder="Hledat anime." />
            <select id="fUser" class="w-compact-sm"><option value="">‚Äî u≈æivatel ‚Äî</option></select>
            <select id="fQual" class="w-compact-sm">
              <option value="">‚Äî kvalita ‚Äî</option><option>480p</option><option>720p</option><option>1080p</option><option>2160p</option>
            </select>
          </div>
        </div>

        <div id="treeWrap" class="tree"></div>
      </div>

      <!-- Panel: P≈ôidat anime -->
      <div id="addAnimePanel" class="card" style="display:none; margin-top:12px;">
        <div class="flex-between"><h2>P≈ôidat anime</h2><button id="btnCloseAddAnime" class="btn">Zav≈ô√≠t</button></div>
        <form id="addAnimeForm" class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
          <div class="row">
            <label>Slug <span class="req">*</span></label>
            <input id="anSlug" type="text" required placeholder="nap≈ô. bleach">
          </div>

          <div class="row">
            <label>N√°zev <span class="req">*</span></label>
            <input id="anTitle" type="text" required placeholder="nap≈ô. Bleach">
          </div>

          <div class="row">
            <label>Poƒçet d√≠l≈Ø <span class="req">*</span></label>
            <input id="anEpisodes" class="tall" type="number" min="1" required placeholder="nap≈ô. 366">
          </div>

          <div class="row">
            <label>Rok <span class="req">*</span></label>
            <input id="anYear" class="tall" type="number" min="1900" max="2100" required placeholder="nap≈ô. 2004">
          </div>

          <div class="row" style="grid-column:1 / -1;">
            <label>≈Ω√°nry (ƒç√°rkou) <span class="req">*</span></label>
            <input id="anGenres" type="text" required placeholder="nap≈ô. Action, Shounen">
          </div>

          <div class="row" style="grid-column:1 / -1;">
            <label>Popis <span class="req">*</span></label>
            <textarea id="anDesc" rows="4" required placeholder="nap≈ô. Ichigo Kurosaki z√≠sk√° s√≠lu Shinigami..."></textarea>
          </div>

          <!-- COVER UPLOAD (data URL) -->
          <div class="row">
            <label>Cover (obr√°zek) <span class="req">*</span></label>
            <input id="anCoverFile" type="file" accept="image/*" required>
            <small class="muted">Nahraj obr√°zek coveru (doporuƒçeno ~ 600√ó900).</small>
            <img id="anCoverPreview" alt="" style="display:none; max-width:160px; border-radius:8px; margin-top:6px; border:1px solid var(--border);">
          </div>

          <div class="row">
            <label>Studio <span class="req">*</span></label>
            <input id="anStudio" type="text" required placeholder="nap≈ô. Studio Pierrot">
          </div>

          <div class="row">
            <label>Status <span class="req">*</span></label>
            <select id="anStatus" required>
              <option value="ongoing">ongoing</option>
              <option value="completed">completed</option>
              <option value="hiatus">hiatus</option>
            </select>
          </div>

          <div class="row" style="grid-column:1 / -1; display:flex; justify-content:flex-end;">
            <button type="submit" class="btn">Ulo≈æit</button>
          </div>
          <p id="addAnimeMsg" class="msg" style="grid-column:1 / -1;"></p>
        </form>
      </div>

      <!-- Panel: Tikety -->
      <div id="ticketsPanel" class="card tickets" style="display:none">
        <div class="flex-between"><h2>Tikety u≈æivatel≈Ø</h2><button id="btnCloseTickets" class="btn">Zav≈ô√≠t</button></div>
        <div id="ticketsList"></div>
      </div>
    </div>
  </main>

  <footer class="site-footer"><small>Admin ‚Ä¢ AnimeCloud</small></footer>

  <script src="scripts/app.js"></script>
  <script>
    App.initNavbar();
    if (!App.isAdmin()){
      document.getElementById('guard').style.display='block';
    } else {
      document.getElementById('content').style.display='block';
      initAdmin();
    }

    function initAdmin(){
      let uploadsAll = App.getUploads().slice().sort((a,b)=>b.ts-a.ts);
      const usersMap = JSON.parse(localStorage.getItem('animecloud_users')||'{ }');

      // DASH
      const dash = document.getElementById('dash');
      const perUser = {};
      uploadsAll.forEach(u => { perUser[u.user]=(perUser[u.user]||0)+1; });
      const topUser = Object.entries(perUser).sort((a,b)=>b[1]-a[1])[0];
      dash.innerHTML = `
        <h2>Dashboard</h2>
        <div class="dash-grid">
          <div class="card"><strong>Poƒçet u≈æivatel≈Ø</strong><div class="muted">${Object.keys(usersMap).length}</div></div>
          <div class="card"><strong>Celkem upload≈Ø</strong><div class="muted">${uploadsAll.length}</div></div>
          <div class="card"><strong>Top uploader</strong><div class="muted">${topUser?`${topUser[0]} (${topUser[1]})`:'‚Äî'}</div></div>
        </div>`;

      // FILTRY + STROM
      const fSearch = document.getElementById('fSearch');
      const fUser   = document.getElementById('fUser');
      const fQual   = document.getElementById('fQual');
      const treeWrap= document.getElementById('treeWrap');
      const uniqueUsers = [...new Set(uploadsAll.map(u=>u.user))].sort();
      fUser.innerHTML = `<option value="">‚Äî u≈æivatel ‚Äî</option>` + uniqueUsers.map(u=>`<option>${u}</option>`).join('');

      function grouped(list){
        const map={};
        list.forEach((u,i)=>{
          const s=u.slug, e=String(u.episode), q=u.quality;
          if(!map[s]) map[s]={};
          if(!map[s][e]) map[s][e]={};
          if(!map[s][e][q]) map[s][e][q]=[];
          map[s][e][q].push({...u,_idx:i});
        });
        return map;
      }
      function buildTree(list){
        const g = grouped(list);
        const slugs = Object.keys(g).sort(); if(!slugs.length) return '<p class="muted">≈Ω√°dn√° data.</p>';
        return slugs.map(slug=>{
          const eps = g[slug];
          const epHtml = Object.keys(eps).sort((a,b)=>Number(a)-Number(b)).map(ep=>{
            const quals = eps[ep];
            const qualHtml = ['480p','720p','1080p','2160p'].map(q=>{
              const arr = (quals[q]||[]).slice().sort((x,y)=>y.ts-x.ts);
              const files = arr.map(u=>`
                <li>
                  <span class="code">${u.videoName}</span>
                  ${u.subsName?`&nbsp;<span class="small">[${u.subsName}]</span>`:''}
                  &nbsp;<span class="small">(${new Date(u.ts).toLocaleString()})</span>
                  <button class="btn danger inline" data-del data-slug="${u.slug}" data-ep="${u.episode}" data-q="${u.quality}" data-name="${u.videoName}">Smazat</button>
                </li>`).join('');
              return `<details><summary>${q==='2160p'?'4K (2160p)':q} <span class="small">(${arr.length}/3)</span></summary><ul class="list-simple tree">${files||'<li class="small">≈Ω√°dn√° data</li>'}</ul></details>`;
            }).join('');
            return `<details><summary>D√≠l ${ep}</summary><div class="tree">${qualHtml}</div></details>`;
          }).join('');
          return `<details><summary>${slug}</summary><div class="tree">${epHtml||'<p class="small">≈Ω√°dn√© d√≠ly</p>'}</div></details>`;
        }).join('');
      }
      function applyFilters(){
        uploadsAll = App.getUploads().slice().sort((a,b)=>b.ts-a.ts);
        let arr = uploadsAll.slice();
        const q = (fSearch.value||'').toLowerCase();
        const u = fUser.value; const qual=fQual.value;
        if(q) arr=arr.filter(x=>x.slug.toLowerCase().includes(q));
        if(u) arr=arr.filter(x=>x.user===u);
        if(qual) arr=arr.filter(x=>x.quality===qual);
        treeWrap.innerHTML = buildTree(arr);
        wireDeleteButtons();
      }
      [fSearch,fUser,fQual].forEach(el=>el.addEventListener('input',applyFilters));
      applyFilters();

      function wireDeleteButtons(){
        treeWrap.querySelectorAll('[data-del]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const slug=btn.dataset.slug, ep=Number(btn.dataset.ep), q=btn.dataset.q, name=btn.dataset.name;
            if (!confirm(`Smazat ${name}?`)) return;
            try{
              const r = await fetch('/delete',{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({anime:slug,episode:ep,quality:q,videoName:name})});
              if(!r.ok) App.toast('Soubor na disku se nepoda≈ôilo smazat','error');
            }catch{ App.toast('Chyba p≈ôipojen√≠','error'); }
            // Lok√°lnƒõ sma≈æ z√°znam a p≈ôerenderuj bez reloadu
            const ls = App.getUploads();
            const idx = ls.findIndex(u=>u.slug===slug&&u.episode===ep&&u.quality===q&&u.videoName===name);
            if(idx>=0){ ls.splice(idx,1); App.setUploads(ls); }
            App.toast('Z√°znam smaz√°n','ok');
            // zachovej otev≈ôen√© vƒõtve
            const openKeys = Array.from(document.querySelectorAll('#treeWrap details[open] > summary'))
              .map(s => s.textContent.trim());
            applyFilters();
            openKeys.forEach(key=>{
              const s = Array.from(document.querySelectorAll('#treeWrap details > summary'))
                .find(x => x.textContent.trim() === key);
              if (s) s.parentElement.setAttribute('open','');
            });
          });
        });
      }

      // Export
      document.getElementById('btnExport').addEventListener('click', ()=>{
        const data = JSON.stringify(App.getUploads(), null, 2);
        const blob = new Blob([data], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='uploads_export.json'; a.click();
        URL.revokeObjectURL(url);
      });

      // Vyƒçistit lok√°ln√≠ katalog (voliteln√©)
      document.getElementById('btnClearLocal').addEventListener('click', ()=>{
        if (!confirm('Smazat lok√°ln√≠ dopl≈àkov√Ω katalog (animecloud_custom_anime)?')) return;
        localStorage.removeItem('animecloud_custom_anime');
        App.toast('Lok√°ln√≠ katalog vyƒçi≈°tƒõn','ok');
      });

      // Tikety (THREAD)
      const ticketsPanel = document.getElementById('ticketsPanel');
      document.getElementById('btnTickets').addEventListener('click', ()=>{ ticketsPanel.style.display='block'; renderTickets(); });
      document.getElementById('btnCloseTickets').addEventListener('click', ()=>ticketsPanel.style.display='none');

      function renderTickets(){
        // zapamatuj otev≈ôen√© tikety podle data-id
        const opened = new Set(
          Array.from(document.querySelectorAll('#ticketsList details[open]')).map(d=>d.dataset.id)
        );
        const list = App.getFeedback().slice().sort((a,b)=>b.ts-a.ts);
        const wrap = document.getElementById('ticketsList');
        if (!list.length){ wrap.innerHTML = '<p class="muted">≈Ω√°dn√© tikety.</p>'; return; }
        wrap.innerHTML = list.map(t => `
          <div class="ticket-card">
            <details data-id="${t.id}" ${opened.has(t.id)?'open':''}>
              <summary>[${t.category||'‚Äî'}] ${new Date(t.ts).toLocaleString()} ‚Äî ${t.user||t.name||'anonym'} ${t.priority?('‚Ä¢ '+t.priority):''} ‚Äî <span class="small">${t.status||'open'}</span></summary>
              <div class="thread">
                ${ (t.messages||[]).map(m => `
                  <div class="msgRow ${m.role==='admin'?'admin':''}">
                    <div>
                      <div class="bubble">${(m.text||'').replace(/</g,'&lt;')}</div>
                      <div class="meta">${m.author||m.role} ‚Ä¢ ${new Date(m.ts).toLocaleString()}</div>
                    </div>
                  </div>`).join('') }
              </div>
              <div class="row" style="margin-top:.6rem;">
                <label>Odpovƒõƒè admina</label>
                <textarea id="reply_${t.id}" rows="3" placeholder="Napi≈° odpovƒõƒè..." ${['resolved','approved','rejected'].includes(t.status)?'disabled':''}></textarea>
              </div>
              <div class="row controls">
                <div class="controls-left">
                  <select id="st_${t.id}">
                    ${['open','approved','rejected','resolved'].map(s=>`<option value="${s}" ${(t.status||'open')===s?'selected':''}>${s}</option>`).join('')}
                  </select>
                </div>
                <div class="controls-right">
                  <button class="btn" data-save="${t.id}">Odeslat</button>
                </div>
              </div>
            </details>
          </div>
        `).join('');

        wrap.querySelectorAll('[data-save]').forEach(b=>{
          b.addEventListener('click', ()=>{
            const id = b.getAttribute('data-save');
            const reply = (document.getElementById('reply_'+id).value||'').trim();
            const st = document.getElementById('st_'+id).value;
            if (reply) {
              App.addTicketMessage(id, {role:'admin', author: App.auth().email, text: reply});
            }
            App.updateFeedback(id, { status: st });
            App.toast('Ticket ulo≈æen','ok');
            renderTickets(); // znovu, ale otev≈ôen√© z≈Østanou d√≠ky 'opened'
          });
        });
      }

      // WIPE uploads
      document.getElementById('btnWipeAll').addEventListener('click', async ()=>{
        const pass = prompt('Zadej heslo pro smaz√°n√≠ V≈†ECH soubor≈Ø v uploads/ (nevratn√©):');
        if (!pass) return;
        try{
          const r = await fetch('/wipe_all',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pass})});
          if (r.ok){ App.setUploads([]); App.toast('Smaz√°no na serveru i lok√°lnƒõ','ok'); location.reload(); }
          else App.toast('≈†patn√© heslo nebo chyba serveru','error');
        }catch{ App.toast('Chyba p≈ôipojen√≠','error'); }
      });

      // Panel P≈ôidat anime ‚Äì otev≈ôen√≠/zav≈ôen√≠
      const addPanel = document.getElementById('addAnimePanel');
      document.getElementById('btnAddAnime').addEventListener('click', ()=> addPanel.style.display='block');
      document.getElementById('btnCloseAddAnime').addEventListener('click', ()=> addPanel.style.display='none');

      // Ulo≈æen√≠ nov√©ho anime ‚Äì VARIANTA B: nejd≈ô√≠v server, pak lok√°lnƒõ
      document.getElementById('addAnimeForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const slug  = document.getElementById('anSlug').value.trim().toLowerCase();
        const title = document.getElementById('anTitle').value.trim();
        const episodes = Number(document.getElementById('anEpisodes').value);
        const genres = document.getElementById('anGenres').value.split(',').map(s=>s.trim()).filter(Boolean);
        const description = document.getElementById('anDesc').value.trim();
        const coverFile = document.getElementById('anCoverFile').files[0];
        const status = document.getElementById('anStatus').value;
        const year = Number(document.getElementById('anYear').value);
        const studio = document.getElementById('anStudio').value.trim();

        const msgEl = document.getElementById('addAnimeMsg');
        if (!slug||!title||!episodes||!genres.length||!description||!coverFile||!status||!year||!studio){
          return App.showMsg(msgEl,'Vypl≈à v≈°echna pole.','error');
        }

        // 1) cover -> data URL
        const cover = await new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.onload = ()=>resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(coverFile);
        });

        // 2) server: zapsat do data/anime.json
        try{
          const resp = await fetch('/admin/add_anime', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ slug, title, episodes, genres, description, cover, status, year, studio })
          });
          if (!resp.ok){
            const tt = await resp.text().catch(()=> '');
            return App.showMsg(msgEl, '‚ö†Ô∏è Nepoda≈ôilo se zapsat do anime.json: ' + (tt||resp.status), 'error');
          }
        } catch(err){
          return App.showMsg(msgEl,'‚ö†Ô∏è Chyba spojen√≠ p≈ôi z√°pisu do anime.json.','error');
        }

        // 3) lok√°lnƒõ pro offline: p≈ôepi≈° p≈ô√≠padn√Ω star√Ω z√°znam se stejn√Ωm slugem
        const storeKey = 'animecloud_custom_anime';
        const list = (JSON.parse(localStorage.getItem(storeKey) || '[]') || []).filter(a=>a.slug!==slug);
        list.push({slug,title,episodes,genres,description,cover,status,year,studio});
        localStorage.setItem(storeKey, JSON.stringify(list));

        // 4) n√°hled coveru a zpr√°va
        const prev = document.getElementById('anCoverPreview');
        prev.src = cover; prev.style.display = 'block';
        App.showMsg(msgEl,'‚úÖ Ulo≈æeno a zaps√°no do anime.json.','ok');
      });
    }
  </script>
</body>
</html>

