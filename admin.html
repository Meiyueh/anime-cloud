<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    details>summary{cursor:pointer;list-style:none;user-select:none;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--panel);margin:8px 0}
    details[open]>summary{background:#191932}
    .small{font-size:.92rem;color:var(--muted)}
    .btn{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:#0f0f1d;color:var(--text);cursor:pointer}
    .btn.danger{background:var(--err);border-color:#a3211a}
    .btn.inline{margin-left:8px}
    .dash-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .flex-between{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .tickets .controls{display:flex;align-items:center;gap:8px;}
    .tickets .controls-left{display:flex;align-items:center;gap:8px;justify-content:flex-start;}
    .tickets .controls-right{margin-left:auto;display:flex;align-items:center;}
    .tickets select{width:auto;min-width:160px;text-align-last:left;min-height:36px;}
    #addAnimePanel input, #addAnimePanel select, #addAnimePanel textarea{ padding:.65rem .7rem; }
    .req{ color:#c62828; margin-left:4px; font-weight:700; }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="brand"><img src="assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="index.html">Info</a>
      <a href="upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="feedback.html" id="nav-feedback" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" aria-current="page" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1>Administrace</h1>

    <div id="guard" class="card" style="display:none">
      <p>Nem√°≈° opr√°vnƒõn√≠. P≈ôihlas se jako <code>admin</code> (nebo √∫ƒçet s rol√≠ admin).</p>
    </div>

    <div id="content" style="display:none">
      <div class="card" id="dash"></div>

      <div class="card" id="uploadsCard">
        <div class="flex-between" style="margin-bottom:8px;">
          <h2>Spr√°va</h2>
          <div class="actions-top" style="display:flex;gap:8px;flex-wrap:wrap;">
            <button id="btnAddAnime" class="btn">P≈ôidat anime</button>
            <button id="btnTickets" class="btn">Tikety</button>
          </div>
        </div>

        <!-- Panel: P≈ôidat anime -->
        <div id="addAnimePanel" class="card" style="display:none; margin-top:12px;">
          <div class="flex-between"><h2>P≈ôidat / upravit anime</h2><button id="btnCloseAddAnime" class="btn">Zav≈ô√≠t</button></div>
          <form id="addAnimeForm" class="grid" style="grid-template-columns:1fr 1fr; gap:12px;">
            <div class="row">
              <label>Slug <span class="req">*</span></label>
              <input id="anSlug" type="text" required placeholder="nap≈ô. bleach">
            </div>
            <div class="row">
              <label>N√°zev <span class="req">*</span></label>
              <input id="anTitle" type="text" required placeholder="nap≈ô. Bleach">
            </div>
            <div class="row">
              <label>Poƒçet d√≠l≈Ø <span class="req">*</span></label>
              <input id="anEpisodes" type="number" min="1" required placeholder="nap≈ô. 366">
            </div>
            <div class="row">
              <label>Rok <span class="req">*</span></label>
              <input id="anYear" type="number" min="1900" max="2100" required placeholder="nap≈ô. 2004">
            </div>
            <div class="row" style="grid-column:1 / -1;">
              <label>≈Ω√°nry (ƒç√°rkou) <span class="req">*</span></label>
              <input id="anGenres" type="text" required placeholder="nap≈ô. Action, Shounen">
            </div>
            <div class="row" style="grid-column:1 / -1;">
              <label>Popis <span class="req">*</span></label>
              <textarea id="anDesc" rows="4" required placeholder="Kr√°tk√Ω popis..."></textarea>
            </div>
            <div class="row">
              <label>Cover (obr√°zek) <span class="req">*</span></label>
              <input id="anCoverFile" type="file" accept="image/*" required>
              <small class="muted">Doporuƒçeno ~ 600√ó900.</small>
              <img id="anCoverPreview" alt="" style="display:none; max-width:160px; border-radius:8px; margin-top:6px; border:1px solid var(--border);">
            </div>
            <div class="row">
              <label>Studio <span class="req">*</span></label>
              <input id="anStudio" type="text" required>
            </div>
            <div class="row">
              <label>Status <span class="req">*</span></label>
              <select id="anStatus" required>
                <option value="ongoing">ongoing</option>
                <option value="completed">completed</option>
                <option value="hiatus">hiatus</option>
              </select>
            </div>
            <div class="row" style="grid-column:1 / -1; display:flex; justify-content:flex-end;">
              <button type="submit" class="btn">Ulo≈æit</button>
            </div>
            <p id="addAnimeMsg" class="msg" style="grid-column:1 / -1;"></p>
          </form>
        </div>

        <!-- Panel: Tikety -->
        <div id="ticketsPanel" class="card tickets" style="display:none">
          <div class="flex-between"><h2>Tikety u≈æivatel≈Ø</h2><button id="btnCloseTickets" class="btn">Zav≈ô√≠t</button></div>
          <div id="ticketsList"></div>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer"><small>Admin ‚Ä¢ AnimeCloud</small></footer>

  <script src="scripts/app.js"></script>
  <script>
    window.CLOUD_BASE = "https://storage.googleapis.com/anime-cloud";
    App.initNavbar();
    if (App.auth().role !== 'admin'){
      document.getElementById('guard').style.display='block';
    } else {
      document.getElementById('content').style.display='block';
      initAdmin();
    }

    async function initAdmin(){
      // DASH z /stats
      try{
        const r = await fetch(App.api('/stats'), { cache:'no-cache' });
        const s = await r.json();
        const dash = document.getElementById('dash');
        if (s && s.ok){
          dash.innerHTML = `
            <h2>Dashboard</h2>
            <div class="dash-grid">
              <div class="card"><strong>Ovƒõ≈ôen√≠ u≈æivatel√©</strong><div class="muted">${s.users_verified}</div></div>
              <div class="card"><strong>Celkem upload≈Ø</strong><div class="muted">${s.uploads_total}</div></div>
              <div class="card"><strong>Nejaktivnƒõj≈°√≠ anime</strong><div class="muted">${s.top_anime?.slug || '‚Äî'} (${s.top_anime?.episodes_with_uploads||0} d√≠l≈Ø)</div></div>
            </div>`;
        }
      } catch {}

      // Ovl√°d√°n√≠ panel≈Ø
      const addPanel = document.getElementById('addAnimePanel');
      document.getElementById('btnAddAnime').addEventListener('click', ()=> addPanel.style.display='block');
      document.getElementById('btnCloseAddAnime').addEventListener('click', ()=> addPanel.style.display='none');

      // Ulo≈æen√≠ nov√©ho anime
      document.getElementById('addAnimeForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const slug  = document.getElementById('anSlug').value.trim().toLowerCase();
        const title = document.getElementById('anTitle').value.trim();
        const episodes = Number(document.getElementById('anEpisodes').value);
        const genres = document.getElementById('anGenres').value.split(',').map(s=>s.trim()).filter(Boolean);
        const description = document.getElementById('anDesc').value.trim();
        const coverFile = document.getElementById('anCoverFile').files[0];
        const status = document.getElementById('anStatus').value;
        const year = Number(document.getElementById('anYear').value);
        const studio = document.getElementById('anStudio').value.trim();
        const msgEl = document.getElementById('addAnimeMsg');

        if (!slug||!title||!episodes||!genres.length||!description||!coverFile||!status||!year||!studio){
          return App.showMsg(msgEl,'Vypl≈à v≈°echna pole.','error');
        }

        // 1) cover -> data URL
        const cover = await new Promise((resolve,reject)=>{
          const r = new FileReader();
          r.onload = ()=>resolve(r.result);
          r.onerror = reject;
          r.readAsDataURL(coverFile);
        });

        try{
          const resp = await fetch(App.api('/admin/add_anime'), {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ slug, title, episodes, genres, description, cover, status, year, studio })
          });
          const payload = await resp.json().catch(()=> ({}));
          if (!resp.ok || !payload?.ok){
            return App.showMsg(msgEl, '‚ö†Ô∏è Nepoda≈ôilo se zapsat do anime.json.', 'error');
          }
          // n√°hled a potvrzen√≠
          const prev = document.getElementById('anCoverPreview');
          prev.src = cover; prev.style.display = 'block';
          App.showMsg(msgEl,'‚úÖ Ulo≈æeno a publikov√°no do anime.json.','ok');
        } catch(err){
          return App.showMsg(msgEl,'‚ö†Ô∏è Chyba spojen√≠ p≈ôi z√°pisu do anime.json.','error');
        }
      });

      // Tikety
      const ticketsPanel = document.getElementById('ticketsPanel');
      document.getElementById('btnTickets').addEventListener('click', ()=>{ ticketsPanel.style.display='block'; renderTickets(); });
      document.getElementById('btnCloseTickets').addEventListener('click', ()=>ticketsPanel.style.display='none');

      async function loadTickets(){
        try{
          const r = await fetch(App.api('/feedback/list'), { cache:'no-cache' });
          const p = await r.json();
          return (p && p.ok) ? (p.items || []) : [];
        } catch { return []; }
      }

      async function renderTickets(){
        const list = await loadTickets();
        const wrap = document.getElementById('ticketsList');
        if (!list.length){ wrap.innerHTML = '<p class="muted">≈Ω√°dn√© tikety.</p>'; return; }

        wrap.innerHTML = list.map(t => `
          <div class="ticket-card">
            <details data-id="${t.id}">
              <summary>[${t.category||'‚Äî'}] ${new Date(t.ts||0).toLocaleString()} ‚Äî ${t.user||t.name||'anonym'} ${t.priority?('‚Ä¢ '+t.priority):''} ‚Äî <span class="small">${t.status||'open'}</span></summary>
              <div class="thread">
                ${(t.messages||[]).map(m => `
                  <div class="msgRow ${m.role==='admin'?'admin':''}">
                    <div>
                      <div class="bubble">${(m.text||'').replace(/</g,'&lt;')}</div>
                      <div class="meta">${m.author||m.role} ‚Ä¢ ${new Date(m.ts||0).toLocaleString()}</div>
                    </div>
                  </div>`).join('')}
              </div>
              <div class="row" style="margin-top:.6rem;">
                <label>Odpovƒõƒè admina</label>
                <textarea id="reply_${t.id}" rows="3" placeholder="Napi≈° odpovƒõƒè..." ${['resolved','approved','rejected'].includes(t.status)?'disabled':''}></textarea>
              </div>
              <div class="row controls">
                <div class="controls-left">
                  <select id="st_${t.id}">
                    ${['open','approved','rejected','resolved'].map(s=>`<option value="${s}" ${(t.status||'open')===s?'selected':''}>${s}</option>`).join('')}
                  </select>
                </div>
                <div class="controls-right">
                  <button class="btn" data-save="${t.id}">Odeslat</button>
                </div>
              </div>
            </details>
          </div>
        `).join('');

        wrap.querySelectorAll('[data-save]').forEach(b=>{
          b.addEventListener('click', async ()=>{
            const id = b.getAttribute('data-save');
            const reply = (document.getElementById('reply_'+id).value||'').trim();
            const st = document.getElementById('st_'+id).value;
            try{
              if (reply){
                await fetch(App.api('/feedback/reply'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id, role:'admin', author: App.auth().email, text: reply }) });
              }
              await fetch(App.api('/feedback/update'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id, status: st }) });
              App.toast('Ticket ulo≈æen','ok');
              renderTickets();
            } catch {
              App.toast('Chyba p≈ôi ukl√°d√°n√≠','error');
            }
          });
        });
      }
    }
  </script>
</body>
</html>
