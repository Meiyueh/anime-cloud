<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    .progress-wrap{width:100%;margin-top:8px}
    .progress{width:100%;height:14px;background:#0f0f1d;border:1px solid var(--border);border-radius:999px;overflow:hidden;position:relative}
    .progress .bar{height:100%;width:0%;background:linear-gradient(90deg,#7c5cff,#35c759,#7c5cff);background-size:200% 100%;animation:slide 2s linear infinite;transition:width .12s ease-out}
    .progress-percent{margin-top:6px;font-size:.9rem;color:var(--muted);text-align:right}
    @keyframes slide{0%{background-position:0% 0}100%{background-position:200% 0}}

    .row-files { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 700px) { .row-files { grid-template-columns: 1fr; } }
    .field { display:flex; flex-direction:column; gap:6px; }
    .file-info{font-size:.9rem;color:var(--muted)}
    #rowAnime, #rowEp, #rowQ {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }
    #panel .row.compact.align-left{ gap: 6px; }
    #panel .row.compact.align-left > div{ margin-top: 0 !important; }

    /* Stejn√° ≈°√≠≈ôka v≈°ech select≈Ø */
    #panel select { width: 320px !important; text-align-last: left; }

    @media (max-width:560px){
      #panel select{ width:100% !important; max-width:none; }
    }

    /* mini progress pro jednotliv√© soubory */
    .file-mini-progress{height:6px;background:#0f0f1d;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .file-mini-progress>div{height:100%;width:0%;background:linear-gradient(90deg,#7c5cff,#35c759,#7c5cff);background-size:200% 100%;animation:slide 2s linear infinite;transition:width .12s}
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="brand"><img src="assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="index.html">Info</a>
      <a href="upload.html" id="nav-upload" aria-current="page">Upload</a>
      <a href="feedback.html" id="nav-feedback" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1>Nahr√°t video + titulky</h1>

    <div class="card" id="uploadBox">
      <div class="align-center">
        <button id="btnOpen" class="w-compact" style="font-size:1.05rem;">Upload</button>
      </div>

      <div id="panel" class="card" style="margin-top:12px;display:none;">
        <!-- Vyber anime -->
        <div class="row compact align-left" id="rowAnime">
          <label for="selAnime">Vyber anime</label>
          <div>
            <select id="selAnime" class="w-compact"></select>
          </div>
        </div>

        <!-- Vyber d√≠l -->
        <div class="row compact align-left" id="rowEp" style="display:none">
          <label for="selEp">Vyber d√≠l</label>
          <div>
            <select id="selEp" class="w-compact"></select>
          </div>
        </div>

        <!-- Vyber kvalitu -->
        <div class="row compact align-left" id="rowQ" style="display:none">
          <label for="selQ">Vyber kvalitu</label>
          <div>
            <select id="selQ" class="w-compact"></select>
          </div>
        </div>

        <div class="row row-files" id="rowFiles" style="display:none">
          <div class="field">
            <label>Video soubor</label>
            <div id="dropVideo" class="dropzone">P≈ôet√°hni sem video nebo klikni pro v√Ωbƒõr</div>
            <input id="fileVideo" type="file" accept="video/*" style="display:none"/>
            <div class="file-info" id="videoInfo">‚Äî</div>
            <div class="file-mini-progress"><div id="miniPV" style="width:0%"></div></div>
          </div>
          <div class="field">
            <label>Titulky (.srt povinn√© pro bƒõ≈æn√© u≈æivatele)</label>
            <div id="dropSubs" class="dropzone">P≈ôet√°hni sem .srt nebo klikni pro v√Ωbƒõr</div>
            <input id="fileSubs" type="file" accept=".srt" style="display:none"/>
            <div class="file-info" id="subsInfo">‚Äî</div>
            <div class="file-mini-progress"><div id="miniPS" style="width:0%"></div></div>
          </div>
        </div>

        <div class="row" id="rowSubmit" style="display:none">
          <button id="btnUpload" type="button">Nahr√°t</button>
          <p class="muted">Admin m≈Ø≈æe nahr√°t i bez .srt. Limit je 3 nahr√°vky na ka≈ædou kvalitu. Max video 3 GB, .srt 2 MB.</p>
        </div>

        <div id="successBox" class="alert hidden"></div>
        <p id="msg" class="msg"></p>
      </div>

      <!-- Celkov√Ω progress -->
      <div id="overallProgress" class="progress-wrap hidden">
        <div class="progress"><div class="bar" id="barOverall"></div></div>
        <div class="progress-percent" id="pctOverall">0%</div>
      </div>
    </div>
  </main>

  <footer class="site-footer"><small>Limit 3/kvalita ‚Ä¢ video povinn√©, .srt pro bƒõ≈æn√© u≈æivatele</small></footer>

  <script src="scripts/app.js"></script>
  <script>
    // GCS ve≈ôejn√° z√°kladna pro ƒçten√≠ (katalog, obr√°zky)
    window.CLOUD_BASE = "https://storage.googleapis.com/anime-cloud";

    App.initNavbar();
    App.guardAuthOnPage('login.html');

    // ---- DOM refs
    const btnOpen = document.getElementById('btnOpen');
    const panel = document.getElementById('panel');
    const selAnime = document.getElementById('selAnime');
    const selEp = document.getElementById('selEp'); const rowEp = document.getElementById('rowEp');
    const selQ = document.getElementById('selQ');  const rowQ  = document.getElementById('rowQ');
    const rowFiles = document.getElementById('rowFiles'); const rowSubmit = document.getElementById('rowSubmit');
    const dropVideo = document.getElementById('dropVideo'); const dropSubs = document.getElementById('dropSubs');
    const fileVideo = document.getElementById('fileVideo'); const fileSubs = document.getElementById('fileSubs');
    const miniPV = document.getElementById('miniPV'); const miniPS = document.getElementById('miniPS');
    const videoInfo = document.getElementById('videoInfo'); const subsInfo = document.getElementById('subsInfo');
    const btnUpload = document.getElementById('btnUpload'); const msg = document.getElementById('msg'); const successBox = document.getElementById('successBox');
    const overall = document.getElementById('overallProgress'); const barOverall = document.getElementById('barOverall'); const pctOverall = document.getElementById('pctOverall');

    let animeList = []; let chosenAnime = null;

    function showSuccess(text){
      successBox.textContent = text;
      successBox.classList.remove('hidden');
      App.toast(text,'ok');
      setTimeout(()=>successBox.classList.add('hidden'), 4500);
    }
    function hideSuccess(){ successBox.classList.add('hidden'); successBox.textContent=''; }

    // otev≈ôi panel + naƒçti katalog z GCS
    btnOpen.addEventListener('click', async ()=> {
      btnOpen.classList.add('hidden'); panel.style.display='block';
      animeList = await App.fetchAnime('data/anime.json'); // App.fetchAnime pou≈æije CLOUD_BASE
      App.populateSelectWithPlaceholder(selAnime, '‚Äî vyber anime ‚Äî');
      animeList.forEach(a => { const opt=document.createElement('option'); opt.value=a.slug; opt.textContent=a.title; selAnime.appendChild(opt); });
      rowEp.style.display='none'; rowQ.style.display='none'; rowFiles.style.display='none'; rowSubmit.style.display='none';
      hideSuccess(); msg.textContent='';
    });

    selAnime.addEventListener('change', e => {
      const slug = e.target.value;
      chosenAnime = animeList.find(a => a.slug === slug) || null;
      if (!chosenAnime){ rowEp.style.display='none'; return; }
      App.populateEpisodesSelect(selEp, chosenAnime.episodes);
      rowEp.style.display='flex'; rowQ.style.display='none'; rowFiles.style.display='none'; rowSubmit.style.display='none';
      hideSuccess(); msg.textContent='';
    });

    selEp.addEventListener('change', () => {
      App.populateSelectWithPlaceholder(selQ, '‚Äî vyber kvalitu ‚Äî');
      const ep = Number(selEp.value);
      ['480p','720p','1080p','2160p'].forEach(q => {
        const countQ = App.getUploadCountByQuality(chosenAnime.slug, ep, q);
        const opt = document.createElement('option'); opt.value = q;
        const label = (q==='2160p') ? '4K (2160p)' : q;
        if (countQ >= 3) { opt.disabled = true; opt.textContent = `${label} (FULL)`; }
        else { opt.textContent = `${label} (${countQ}/3)`; }
        selQ.appendChild(opt);
      });
      rowQ.style.display='flex'; rowFiles.style.display='none'; rowSubmit.style.display='none';
      hideSuccess(); msg.textContent='';
    });

    selQ.addEventListener('change', () => { rowFiles.style.display='grid'; maybeEnableSubmit(); hideSuccess(); msg.textContent=''; });

    // Drag&Drop helpers
    function wireDropzone(zone, input, info, mini) {
      zone.addEventListener('click', ()=> input.click());
      zone.addEventListener('dragover', e=>{ e.preventDefault(); zone.classList.add('dragover'); });
      zone.addEventListener('dragleave', ()=> zone.classList.remove('dragover'));
      zone.addEventListener('drop', e=>{
        e.preventDefault(); zone.classList.remove('dragover');
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          input.files = e.dataTransfer.files;
          input.dispatchEvent(new Event('change'));
        }
      });
      input.addEventListener('change', ()=>{
        const f = input.files[0];
        if (!f){ info.textContent = '‚Äî'; mini.style.width='0%'; return; }
        info.textContent = `${f.name} (${App.fmtBytes(f.size)})`;
        mini.style.width='0%';
        maybeEnableSubmit();
      });
    }
    wireDropzone(dropVideo, fileVideo, videoInfo, miniPV);
    wireDropzone(dropSubs, fileSubs, subsInfo, miniPS);

    // Validace + zobrazit submit
    function maybeEnableSubmit(){
      const isAdmin = App.auth().role === 'admin';
      const v = fileVideo.files[0]; const s = fileSubs.files[0];
      const hasVideo = !!v, hasSubs = !!s;
      if (hasVideo && v.size > 3 * 1024 * 1024 * 1024) { App.showMsg(msg, 'Video je vƒõt≈°√≠ ne≈æ 3 GB.', 'error'); rowSubmit.style.display='none'; return; }
      if (!isAdmin && hasSubs && s.size > 2 * 1024 * 1024) { App.showMsg(msg, 'SRT je vƒõt≈°√≠ ne≈æ 2 MB.', 'error'); rowSubmit.style.display='none'; return; }
      rowSubmit.style.display = (hasVideo && (hasSubs || isAdmin)) ? 'block' : 'none';
    }

    // ---- Signed URL helpery
    async function signUrls({ slug, ep, q, videoOut, vFile, subsOut, sFile }) {
      const payload = {
        anime: slug,
        episode: ep,
        quality: q,
        videoName: videoOut,
        videoType: vFile.type || mimeFromExt(vFile.name) || "video/mp4",
        ...(sFile ? { subsName: subsOut, subsType: "application/x-subrip" } : {})
      };
      const r = await fetch(App.api('/upload/sign'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const p = await r.json().catch(()=>null);
      if (!r.ok || !p?.ok) {
        const err = (p && p.error) ? p.error : `HTTP ${r.status}`;
        throw new Error('sign_failed: '+err);
      }
      return p;
    }

    function putWithProgress(url, file, contentType, onProgress) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('PUT', url);
        xhr.setRequestHeader('Content-Type', contentType || 'application/octet-stream');
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable && typeof onProgress === 'function') {
            onProgress(e.loaded, e.total);
          }
        };
        xhr.onload = () => {
          if (xhr.status >= 200 && xhr.status < 300) resolve();
          else reject(new Error(`PUT failed: ${xhr.status} ${xhr.responseText || ''}`));
        };
        xhr.onerror = () => reject(new Error('network_error'));
        xhr.send(file);
      });
    }

    // util: MIME podle p≈ô√≠pony (fallback)
    function mimeFromExt(name){
      const n = (name||'').toLowerCase();
      if (n.endsWith('.mp4')) return 'video/mp4';
      if (n.endsWith('.webm')) return 'video/webm';
      if (n.endsWith('.mkv')) return 'video/x-matroska';
      if (n.endsWith('.mov')) return 'video/quicktime';
      if (n.endsWith('.m4v')) return 'video/x-m4v';
      return '';
    }

    // Upload + progress (p≈ô√≠m√Ω PUT do GCS)
    btnUpload.addEventListener('click', async () => {
      const a = App.auth(); if (!chosenAnime) return;
      const ep = Number(selEp.value); const q = selQ.value;
      const v = fileVideo.files[0]; const s = fileSubs.files[0]; const isAdmin = (a.role === 'admin');

      if (!selAnime.value || !ep || !q || !v) return App.showMsg(msg, 'Vyber anime, d√≠l, kvalitu a video.', 'error');
      if (!isAdmin){
        if (!s) return App.showMsg(msg, 'Titulky (.srt) jsou povinn√©.', 'error');
        if (!s.name.toLowerCase().endsWith('.srt')) return App.showMsg(msg, 'Titulky mus√≠ b√Ωt .srt.', 'error');
      }

      const currentQ = App.getUploadCountByQuality(chosenAnime.slug, ep, q);
      if (currentQ >= 3) return App.showMsg(msg, `Limit pro ${q} je pln√Ω (3/3).`, 'error');
      const nextIndex = currentQ + 1;
      const vExt = App.extOrDefault(v.name, 'mp4');
      const videoOut = `${q}_${nextIndex}.${vExt}`;
      const subsOut  = s ? `${q}_${nextIndex}.srt` : null;

      overall.classList.remove('hidden');
      barOverall.style.width='0%'; pctOverall.textContent='0%';
      miniPV.style.width='0%'; miniPS.style.width='0%';
      hideSuccess(); msg.textContent='';

      try {
        // 1) vy≈æ√°dat Signed URL ze serveru
        const signed = await signUrls({ slug: chosenAnime.slug, ep, q, videoOut, vFile: v, subsOut, sFile: s });

        // 2) nahr√°t VIDEO
        const totalBytes = (v?.size||0) + (s?.size||0);
        let uploadedBytes = 0;
        const updOverall = (absLoaded) => {
          const pct = Math.round(((absLoaded) / (totalBytes || 1)) * 100);
          barOverall.style.width = pct + '%';
          pctOverall.textContent = pct + '%';
        };

        await putWithProgress(signed.video.put_url, v, signed.video.content_type, (loaded, total) => {
          miniPV.style.width = Math.round((loaded/total)*100) + '%';
          updOverall(loaded + (s ? 0 : 0));
        });
        uploadedBytes += v.size; updOverall(uploadedBytes);

        // 3) nahr√°t SUBS (pokud jsou)
        if (s && signed.subs) {
          await putWithProgress(signed.subs.put_url, s, signed.subs.content_type, (loaded, total) => {
            miniPS.style.width = Math.round((loaded/total)*100) + '%';
            updOverall(uploadedBytes + loaded);
          });
          uploadedBytes += s.size; updOverall(uploadedBytes);
        }

        // 4) zapsat lok√°ln√≠ z√°znam + UI
        App.addUploadRecord({ slug: chosenAnime.slug, episode: ep, quality: q, videoName: videoOut, subsName: s ? subsOut : null, user: a.email, ts: Date.now() });

        // aktualizace poƒç√≠tadel kvality
        for (const opt of selQ.options){
          if (!opt.value) continue;
          const c = App.getUploadCountByQuality(chosenAnime.slug, ep, opt.value);
          const base = (opt.value==='2160p') ? '4K (2160p)' : opt.value;
          if (c>=3){ opt.disabled=true; opt.textContent = `${base} (FULL)`; }
          else { opt.textContent = `${base} (${c}/3)`; }
        }

        rowSubmit.style.display='none'; fileVideo.value=''; fileSubs.value='';
        videoInfo.textContent='‚Äî'; subsInfo.textContent='‚Äî';
        showSuccess(`‚úÖ Nahr√°no: ${chosenAnime.title} ¬∑ d√≠l ${ep} ¬∑ ${q} (${videoOut})`);

        barOverall.style.width='100%'; pctOverall.textContent='100%';
        setTimeout(()=>overall.classList.add('hidden'), 900);
      } catch (e) {
        console.error(e);
        App.showMsg(msg, '‚ùå Upload selhal: ' + (e && e.message ? e.message : e), 'error');
        overall.classList.add('hidden');
      }
    });

    // AUTO-P≈òEDVOLBA z indexu (zachov√°no)
    (async function preselectFromIndex(){
      const slug = localStorage.getItem('preselect_anime');
      if (!slug) return;
      localStorage.removeItem('preselect_anime');
      const a = App.auth(); if (!a.email) return;
      btnOpen.click();
      const wait = (ms)=>new Promise(r=>setTimeout(r,ms));
      for (let i=0;i<20;i++){ if (animeList && animeList.length) break; await wait(100); }
      const found = animeList.find(x => x.slug === slug);
      if (!found) return;
      selAnime.value = slug; selAnime.dispatchEvent(new Event('change', {bubbles:true}));
    })();
  </script>
</body>
</html>
