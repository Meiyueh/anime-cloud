<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî √övod</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    /* velk√Ω cover 190√ó570 */
    .cover-tall{width:190px;height:570px;object-fit:cover;object-position:center;border-radius:12px;background:var(--border);display:block;margin:0 auto;}
    .anime-card{display:flex;flex-direction:column;align-items:center;gap:.6rem;text-align:center;padding:.8rem;cursor:pointer;text-decoration:none;color:inherit}
    .anime-title{font-weight:600;}
    .anime-meta{color:var(--muted);font-size:.95rem;}

    /* hlaviƒçka sekce */
    .row-head{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:24px;}
    .actions{display:flex;align-items:center;gap:8px}
    .search{display:none}
    .search input{min-width:260px;background:#12122b;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:.45rem .6rem}
    :root[data-theme="light"] .search input{background:#fff}

    /* grid pro ob√°lky ‚Äì min 190px */
    #anime-grid{grid-template-columns:repeat(auto-fill,minmax(190px,1fr))}

    /* pager */
    .pager{display:flex;align-items:center;justify-content:center;gap:10px;margin-top:12px}
    .pager button{min-width:42px}
    .pager .page-num{min-width:36px;text-align:center}
    .center-row{display:flex;justify-content:center;margin-top:12px}

    @media (max-width:700px){
      .row-head{ margin-bottom:16px; }
    }

    .anime-card:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
    .anime-card img { transition: transform .3s; }
    .anime-card:hover img { transform: scale(1.03); }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="brand">
      <img src="assets/logo.svg" alt="AnimeCloud" />
    </a>
    <nav class="top-nav">
      <a href="index.html" aria-current="page">Info</a>
      <a href="upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="feedback.html" id="nav-feedback" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1>V√≠tej v AnimeCloud</h1>

    <div class="card">
      <h2>Statistiky</h2>
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 12px;">
        <div class="card"><strong>Poƒçet anime</strong><div id="stat-anime" class="muted">‚Äì</div></div>
        <div class="card"><strong>Registrovan√≠ u≈æivatel√©</strong><div id="stat-users" class="muted">‚Äì</div></div>
        <div class="card"><strong>Celkem upload≈Ø</strong><div id="stat-uploads" class="muted">‚Äì</div></div>
        <div class="card"><strong>Nejaktivnƒõj≈°√≠ anime</strong><div id="stat-top-anime" class="muted">‚Äì</div></div>
      </div>
    </div>

    <div class="card">
      <div class="row-head">
        <h2 style="margin:0">Katalog anime</h2>
        <div class="actions">
          <div class="search" id="searchWrap">
            <input id="searchInput" type="text" placeholder="Hledat: title / genres / studio / year" />
          </div>
        </div>
      </div>

      <div id="anime-grid" class="grid anime"></div>

      <!-- tlaƒç√≠tko pod √∫vodn√≠ ƒçtve≈ôic√≠ -->
      <div id="teaserMoreRow" class="center-row">
        <button id="btnTeaserMore">Zobrazit dal≈°√≠</button>
      </div>

      <!-- str√°nkov√°n√≠ dole -->
      <div id="pager" class="pager hidden">
        <button id="btnPrev" aria-label="P≈ôedchoz√≠">‚Äπ</button>
        <span id="pageNum" class="page-num">1</span>
        <button id="btnNext" aria-label="Dal≈°√≠">‚Ä∫</button>
      </div>
    </div>
  </main>

  <footer class="site-footer"><small>AnimeCloud ‚Ä¢ Online verze</small></footer>

  <script src="scripts/app.js"></script>
  <script>
    window.CLOUD_BASE = "https://storage.googleapis.com/anime-cloud";
    App.initNavbar();

    // --- helpery ---
    const strip = (s)=> (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
    const debounce = (fn,ms)=>{let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

    (async function(){
      // 1) katalog z GCS
      const anime = await App.fetchAnime(`${window.CLOUD_BASE}/data/anime.json`);
      document.getElementById('stat-anime').textContent = String(anime.length);

      // 2) glob√°ln√≠ statistiky z na≈°eho serveru (/stats)
      try {
        const r = await fetch(App.api('/stats'));
        const s = await r.json();
        if (s?.ok) {
          document.getElementById('stat-users').textContent   = String(s.users);
          document.getElementById('stat-uploads').textContent = String(s.uploads);
          const top = s.top_anime;
          document.getElementById('stat-top-anime').textContent = top ? `${top.slug} ‚Äî ${top.episodes} d√≠l≈Ø` : '‚Äî';
        } else {
          // fallback na lok√°l
          const users = JSON.parse(localStorage.getItem('animecloud_users') || '{}');
          document.getElementById('stat-users').textContent   = String(Object.keys(users).length);
          document.getElementById('stat-uploads').textContent = String(App.getUploads().length);
          document.getElementById('stat-top-anime').textContent = '‚Äî';
        }
      } catch {
        const users = JSON.parse(localStorage.getItem('animecloud_users') || '{}');
        document.getElementById('stat-users').textContent   = String(Object.keys(users).length);
        document.getElementById('stat-uploads').textContent = String(App.getUploads().length);
        document.getElementById('stat-top-anime').textContent = '‚Äî';
      }

      // --- zbytek: grid se≈ôazen√Ω lehce podle lok√°ln√≠ch upload≈Ø (pro UX),
      // glob√°ln√≠ top se bere v√Ω≈°e ze /stats
      const uploads = App.getUploads();
      const uniqKey = {}; uploads.forEach(u => { uniqKey[`${u.slug}#${u.episode}`] = 1; });
      const uploadedPerAnime = {};
      Object.keys(uniqKey).forEach(k => {
        const slug = k.split('#')[0];
        uploadedPerAnime[slug] = (uploadedPerAnime[slug] || 0) + 1;
      });

      const sorted = anime.slice().sort((a,b)=>{
        const ca = uploadedPerAnime[a.slug] || 0;
        const cb = uploadedPerAnime[b.slug] || 0;
        if (cb !== ca) return cb - ca;
        return a.title.localeCompare(b.title, 'cs');
      });

      // DOM refs
      const grid = document.getElementById('anime-grid');
      const teaserMoreRow = document.getElementById('teaserMoreRow');
      const btnTeaserMore = document.getElementById('btnTeaserMore');
      const pager = document.getElementById('pager');
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');
      const pageNum = document.getElementById('pageNum');
      const searchWrap = document.getElementById('searchWrap');
      const searchInput = document.getElementById('searchInput');

      // STAV
      let mode = 'teaser'; // 'teaser' | 'paged'
      const pageSize = 20;
      let page = 1;
      let filtered = sorted.slice(); // pro search

      function cardHTML(a){
        const x = uploadedPerAnime[a.slug] || 0;
        const y = a.episodes;

        const coverSrc = (() => {
          const c = a.cover || '';
          if (/^https?:\/\//.test(c)) return c;
          if (c.startsWith('covers/')) return `${window.CLOUD_BASE}/${c}`;
          if (!c) return 'assets/logo.svg';
          return c;
        })();

        return `
          <a href="#" class="card anime-card" data-slug="${a.slug}">
            <img class="cover-tall" loading="lazy" src="${coverSrc}" alt="${a.title}" onerror="this.src='assets/logo.svg'">
            <div class="anime-title">${a.title}</div>
            <div class="anime-meta">${x}/${y} d√≠l≈Ø nahr√°no</div>
          </a>
        `;
      }

      function renderTeaser(){
        const first4 = sorted.slice(0,4);
        grid.innerHTML = first4.map(cardHTML).join('');
        teaserMoreRow.classList.remove('hidden');
        pager.classList.add('hidden');
        searchWrap.style.display = 'none';
        attachCardClicks();
        if (sorted.length <= 4) { teaserMoreRow.classList.add('hidden'); }
      }

      function totalPages(){ return Math.max(1, Math.ceil(filtered.length / pageSize)); }

      function renderPaged(){
        const start = (page-1)*pageSize;
        const slice = filtered.slice(start, start + pageSize);
        grid.innerHTML = slice.map(cardHTML).join('') || '<p class="muted">Nic k zobrazen√≠.</p>';
        teaserMoreRow.classList.add('hidden');
        pager.classList.remove('hidden');
        pageNum.textContent = String(page);
        btnPrev.disabled = (page <= 1);
        btnNext.disabled = (page >= totalPages());
        attachCardClicks();
      }

      function attachCardClicks(){
        const isLogged = !!App.auth().email;
        grid.querySelectorAll('.anime-card').forEach(el=>{
          el.addEventListener('click', (e)=>{
            e.preventDefault();
            if (!isLogged) { App.toast('Pro nahr√°n√≠ se p≈ôihlas.', 'error'); return; }
            const slug = el.getAttribute('data-slug');
            localStorage.setItem('preselect_anime', slug);
            location.href = 'upload.html';
          });
        });
      }

      renderTeaser();

      btnTeaserMore.addEventListener('click', ()=>{
        mode = 'paged';
        page = 1;
        searchWrap.style.display = 'block';
        renderPaged();
      });

      btnPrev.addEventListener('click', ()=>{ if (page>1){ page--; renderPaged(); }});
      btnNext.addEventListener('click', ()=>{ if (page<totalPages()){ page++; renderPaged(); }});

      const onSearch = debounce(()=>{
        const q = strip(searchInput.value);
        filtered = sorted.filter(a=>{
          if (!q) return true;
          const hay = [a.title, (a.genres||[]).join(' '), a.studio, String(a.year)].map(strip).join(' ');
          return hay.includes(q);
        });
        page = 1;
        if (mode === 'teaser'){
          mode = 'paged';
          searchWrap.style.display='block';
        }
        renderPaged();
      }, 200);
      searchInput.addEventListener('input', onSearch);
    })();
  </script>
</body>
</html>
