<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî Feedback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    details>summary{list-style:none;cursor:pointer}
    details>summary::marker{content:''}
    details>summary .summary-line{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    details>summary .marker{width:8px;height:8px;border-radius:50%;background:var(--brand)}
    .thread{margin-top:.6rem}
    .msgRow{display:flex;gap:8px;margin:.35rem 0}
    .msgRow.admin{justify-content:flex-end}
    .bubble{max-width:80%;padding:.45rem .6rem;border-radius:10px;border:1px solid var(--border);background:#14142a}
    .msgRow.admin .bubble{background:#1f233d}
    .meta{font-size:.8rem;color:var(--muted);margin-top:.2rem}
    .centered{max-width:640px;margin:0 auto; text-align:left;}
    .btn{ padding:.48rem .8rem; border-radius:8px; width:auto !important; }
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="brand"><img src="assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="index.html">Info</a>
      <a href="upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="feedback.html" id="nav-feedback" aria-current="page" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1 class="centered">Zpƒõtn√° vazba &amp; Tikety</h1>
    <p class="muted centered">Napi≈° chybu, n√°vrh nebo ≈æ√°dost. Admini uvid√≠ a mohou odpov√≠dat ‚Äì vznikne konverzace.</p>

    <form id="feedbackForm" class="card centered">
      <div class="row"><label for="fbName">Jm√©no / e-mail (voliteln√©)</label><input type="text" id="fbName" placeholder="nap≈ô. animefan123"/></div>
      <div class="row">
        <label for="fbCategory">Kategorie</label>
        <select id="fbCategory" required>
          <option value="">‚Äî Vyber kategorii ‚Äî</option>
          <option value="bug">üêû Chyba</option>
          <option value="suggestion">üí° N√°vrh</option>
          <option value="request">üìå ≈Ω√°dost</option>
          <option value="other">‚úâÔ∏è Ostatn√≠</option>
        </select>
      </div>
      <div class="row">
        <label for="fbPriority">Priorita</label>
        <select id="fbPriority">
          <option value="normal">Norm√°ln√≠</option>
          <option value="high">Vysok√°</option>
        </select>
      </div>
      <div class="row"><label for="fbMessage">Zpr√°va</label><textarea id="fbMessage" rows="5" required placeholder="Popi≈° sv≈Øj n√°vrh nebo probl√©m..."></textarea></div>
      <div class="row align-right"><button type="submit" class="btn w-compact-sm">Odeslat</button></div>
      <p id="fbMsg" class="msg"></p>
    </form>

    <div class="card centered">
      <h2>Moje tikety</h2>
      <div id="myTickets">‚Äî</div>
    </div>
  </main>

  <footer class="site-footer"><small>D√≠ky za zpƒõtnou vazbu ‚ù§Ô∏è</small></footer>

  <script src="scripts/app.js"></script>
  <script>
    window.CLOUD_BASE = "https://storage.googleapis.com/anime-cloud";
    App.initNavbar(); App.guardAuthOnPage('login.html');

    const a = App.auth();
    const msgBox = document.getElementById('fbMsg');
    const myTicketsBox = document.getElementById('myTickets');

    // ‚Äî‚Äî‚Äî UTIL ‚Äî‚Äî‚Äî
    const esc = (s)=> String(s||'').replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch]));
    const eq = (x,y)=> String(x||'').toLowerCase() === String(y||'').toLowerCase();

    function normalizeTicket(t){
      // sjednotit star≈°√≠ strukturu {message} -> messages[0]
      const msgs = [];
      if (t.message && (!Array.isArray(t.messages) || !t.messages.length)) {
        msgs.push({ id: t.id+'_0', role:'user', author: t.user || t.name || 'anonym', text: t.message, ts: t.ts || Date.now() });
      }
      if (Array.isArray(t.messages)) msgs.push(...t.messages);
      msgs.sort((x,y)=> (x.ts||0) - (y.ts||0));
      return { ...t, messages: msgs };
    }

    function belongsToUser(t){
      if (t.user && eq(t.user, a.email)) return true;
      // kdy≈æ chyb√≠ t.user, bereme vlastnictv√≠ podle prvn√≠ zpr√°vy autora
      const first = (t.messages||[])[0];
      return first ? eq(first.author, a.email) : false;
    }

    async function fetchTicketsServer(){
      try{
        const r = await fetch(App.api('/feedback/list'), { cache:'no-cache' });
        const p = await r.json().catch(()=> ({}));
        if (!p?.ok || !Array.isArray(p.items)) return [];
        return p.items.map(normalizeTicket);
      }catch{ return []; }
    }

    async function renderMyTickets(){
      const all = await fetchTicketsServer();
      const list = all.filter(belongsToUser).sort((x,y)=> (y.ts||0) - (x.ts||0));

      if (!list.length){
        myTicketsBox.innerHTML = '<p class="muted">Zat√≠m ≈æ√°dn√©.</p>';
        return;
      }

      const opened = new Set(Array.from(myTicketsBox.querySelectorAll('details[open]')).map(d=>d.dataset.id));

      myTicketsBox.innerHTML = list.map(t => `
        <details data-id="${t.id}" ${opened.has(t.id)?'open':''}>
          <summary>
            <span class="summary-line">
              <span class="marker"></span>
              <strong>[${esc(t.category||'‚Äî')}]</strong>
              <span class="muted">${new Date(t.ts||Date.now()).toLocaleString()} ‚Ä¢ ${esc(t.priority||'normal')}</span>
              <span class="muted">‚Ä¢ stav: ${esc(t.status||'open')}</span>
            </span>
          </summary>

          <div class="thread">
            ${(t.messages||[]).map(m => `
              <div class="msgRow ${m.role==='admin'?'admin':''}">
                <div>
                  <div class="bubble">${esc(m.text||'')}</div>
                  <div class="meta">${esc(m.author||m.role||'')} ‚Ä¢ ${new Date(m.ts||Date.now()).toLocaleString()}</div>
                </div>
              </div>
            `).join('')}
          </div>

          ${ ['resolved','approved','rejected'].includes(t.status) ? `
            <p class="muted" style="margin-top:.5rem">Tiket je uzav≈ôen administr√°torem.</p>
          ` : `
            <div class="row" style="margin-top:.6rem;">
              <label>Moje odpovƒõƒè</label>
              <textarea id="reply_${t.id}" rows="3" placeholder="Napi≈° zpr√°vu..."></textarea>
            </div>
            <div class="row align-right"><button class="btn w-compact-sm" data-reply="${t.id}">Odeslat odpovƒõƒè</button></div>
          `}
        </details>
      `).join('');

      myTicketsBox.querySelectorAll('[data-reply]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-reply');
          const ta = document.getElementById('reply_'+id);
          const text = (ta?.value || '').trim();
          if (!text) return;
          try{
            const r = await fetch(App.api('/feedback/update'), {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ id, message: text, role:'user', author: a.email })
            });
            const p = await r.json().catch(()=> ({}));
            if (p?.ok){ App.toast('Odesl√°no','ok'); ta.value=''; await renderMyTickets(); }
            else { App.toast('Chyba p≈ôi ukl√°d√°n√≠','error'); }
          }catch{
            App.toast('Chyba p≈ôipojen√≠','error');
          }
        });
      });
    }

    // ‚Äî‚Äî‚Äî submit nov√©ho tiketu: rovnou se serverovou strukturou s messages[0] ‚Äî‚Äî‚Äî
    document.getElementById('feedbackForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const ts = Date.now();
      const firstMsg = (document.getElementById('fbMessage').value||'').trim();
      const nameOpt  = document.getElementById('fbName').value.trim();

      const payload = {
        id: 'tkt_'+ts,
        user: a.email || null,
        name: nameOpt || null,
        category: document.getElementById('fbCategory').value,
        priority: document.getElementById('fbPriority').value,
        status: 'open',
        ts,
        messages: [{
          id: 'msg_'+ts+'_0',
          role: 'user',
          author: a.email || (nameOpt || 'anonym'),
          text: firstMsg,
          ts
        }]
      };
      if (!payload.category || !firstMsg) return App.showMsg(msgBox,'Vypl≈à kategorii a zpr√°vu.','error');

      try{
        const r = await fetch(App.api('/feedback'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if (!r.ok) throw new Error('HTTP '+r.status);
        e.target.reset();
        App.showMsg(msgBox,'‚úÖ Odesl√°no. Dƒõkujeme!','ok');
        await renderMyTickets();
      }catch(err){
        App.showMsg(msgBox,'‚ö†Ô∏è Server nedostupn√Ω. Zkus to pros√≠m pozdƒõji.','error');
      }
    });

    renderMyTickets();
  </script>
</body>
</html>
