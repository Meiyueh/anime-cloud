<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî Feedback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    details>summary{list-style:none;cursor:pointer}
    details>summary::marker{content:''}
    details>summary .summary-line{display:flex;align-items:center;gap:8px}
    details>summary .marker{width:8px;height:8px;border-radius:50%;background:var(--brand)}
    .thread{margin-top:.6rem}
    .msgRow{display:flex;gap:8px;margin:.35rem 0}
    .msgRow.admin{justify-content:flex-end}
    .bubble{max-width:80%;padding:.45rem .6rem;border-radius:10px;border:1px solid var(--border);background:#14142a;white-space:pre-wrap}
    .msgRow.admin .bubble{background:#1f233d}
    .meta{font-size:.8rem;color:var(--muted);margin-top:.2rem}
    .centered{max-width:640px;margin:0 auto; text-align:left;}
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="brand"><img src="assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="index.html">Info</a>
      <a href="upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="feedback.html" id="nav-feedback" aria-current="page" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1 class="centered">Zpƒõtn√° vazba &amp; Tikety</h1>
    <p class="muted centered">Napi≈° chybu, n√°vrh nebo ≈æ√°dost. Tiket se ulo≈æ√≠ na server a admini na nƒõj mohou reagovat.</p>

    <form id="feedbackForm" class="card centered">
      <div class="row"><label for="fbName">Jm√©no / e-mail (voliteln√©)</label><input type="text" id="fbName" placeholder="nap≈ô. animefan123"/></div>
      <div class="row">
        <label for="fbCategory">Kategorie</label>
        <select id="fbCategory" required>
          <option value="">‚Äî Vyber kategorii ‚Äî</option>
          <option value="bug">üêû Chyba</option>
          <option value="suggestion">üí° N√°vrh</option>
          <option value="request">üìå ≈Ω√°dost</option>
          <option value="other">‚úâÔ∏è Ostatn√≠</option>
        </select>
      </div>
      <div class="row">
        <label for="fbPriority">Priorita</label>
        <select id="fbPriority">
          <option value="normal">Norm√°ln√≠</option>
          <option value="high">Vysok√°</option>
        </select>
      </div>
      <div class="row"><label for="fbMessage">Zpr√°va</label><textarea id="fbMessage" rows="5" required placeholder="Popi≈° sv≈Øj n√°vrh nebo probl√©m..."></textarea></div>
      <div class="row align-right"><button type="submit" class="w-compact-sm">Odeslat</button></div>
      <p id="fbMsg" class="msg"></p>
    </form>

    <div class="card centered">
      <h2>Moje tikety</h2>
      <div id="myTickets">‚Äî</div>
    </div>
  </main>

  <footer class="site-footer"><small>D√≠ky za zpƒõtnou vazbu ‚ù§Ô∏è</small></footer>

  <script src="scripts/app.js"></script>
  <script>
    window.CLOUD_BASE = "https://storage.googleapis.com/anime-cloud";
    App.initNavbar(); App.guardAuthOnPage('login.html');
    const a = App.auth();

    // odesl√°n√≠ nov√©ho (ulo≈æ√≠ se na server i lok√°lnƒõ jako fallback)
    document.getElementById('feedbackForm').addEventListener('submit', async e=>{
      e.preventDefault();
      const ts = Date.now();
      const payload = {
        id: 'tkt_'+ts,
        user: a.email || null,
        name: document.getElementById('fbName').value.trim() || null,
        category: document.getElementById('fbCategory').value,
        priority: document.getElementById('fbPriority').value,
        message: document.getElementById('fbMessage').value.trim(),
        status: 'open',
        ts
      };
      if (!payload.category || !payload.message) return App.showMsg(document.getElementById('fbMsg'),'Vypl≈à kategorii a zpr√°vu.','error');

      // save on server
      try{ await fetch(App.api('/feedback'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});}catch{}
      // local mirror
      App.saveFeedback(payload);

      e.target.reset();
      App.showMsg(document.getElementById('fbMsg'),'‚úÖ Odesl√°no. Dƒõkujeme!','ok');
      renderMyTickets();
    });

    async function fetchServerTickets(){
      try{
        const r = await fetch(App.api('/feedback/list'));
        const p = await r.json();
        return p?.ok ? (p.items||[]) : [];
      }catch{return [];}
    }

    function sanitize(s){ return String(s||'').replace(/</g,'&lt;'); }

    async function renderMyTickets(){
      const all = await fetchServerTickets();
      const mine = all.filter(t => t.user === a.email).sort((x,y)=> (y.ts||0)-(x.ts||0));

      const box = document.getElementById('myTickets');
      if (!mine.length){ box.innerHTML = '<p class="muted">Zat√≠m ≈æ√°dn√©.</p>'; return; }

      box.innerHTML = mine.map(t=>`
        <details>
          <summary>
            <span class="summary-line">
              <span class="marker"></span>
              <strong>[${sanitize(t.category)}]</strong>
              <span class="muted">${new Date(t.ts||Date.now()).toLocaleString()} ‚Ä¢ ${sanitize(t.priority||'normal')}</span>
              <span class="muted">‚Ä¢ stav: ${sanitize(t.status||'open')}</span>
            </span>
          </summary>

          <div class="thread">
            ${(t.messages||[]).map(m => `
              <div class="msgRow ${m.role==='admin'?'admin':''}">
                <div>
                  <div class="bubble">${sanitize(m.text)}</div>
                  <div class="meta">${sanitize(m.author||m.role)} ‚Ä¢ ${new Date(m.ts||Date.now()).toLocaleString()}</div>
                </div>
              </div>`).join('')}
          </div>

          ${ ['resolved','approved','rejected'].includes(t.status) ? `
            <p class="muted" style="margin-top:.5rem">Tiket je uzav≈ôen administr√°torem.</p>
          ` : `
            <div class="row" style="margin-top:.6rem;">
              <label>Moje odpovƒõƒè</label>
              <textarea id="reply_${t.id}" rows="3" placeholder="Napi≈° zpr√°vu..."></textarea>
            </div>
            <div class="row align-right"><button class="btn w-compact-sm" data-reply="${t.id}">Odeslat odpovƒõƒè</button></div>
          `}
        </details>
      `).join('');

      box.querySelectorAll('[data-reply]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const id = b.getAttribute('data-reply');
          const ta = document.getElementById('reply_'+id);
          const txt = (ta.value||'').trim(); if(!txt) return;
          try{
            const resp = await fetch(App.api('/feedback/update'),{
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ id, message: txt, role:'user', author: a.email })
            });
            const p = await resp.json();
            if (p?.ok){ App.toast('Odesl√°no','ok'); ta.value=''; renderMyTickets(); }
            else App.toast('Chyba p≈ôi ukl√°d√°n√≠','error');
          }catch{ App.toast('Chyba p≈ôipojen√≠','error'); }
        });
      });
    }

    renderMyTickets();
  </script>
</body>
</html>
