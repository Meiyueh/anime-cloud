<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî M≈Øj √∫ƒçet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    .toolbar{display:flex;gap:.6rem;justify-content:flex-end;align-items:center;flex-wrap:wrap;margin-top:.6rem}
    @media (max-width:640px){ .toolbar{ justify-content:flex-start; } }
    .btn{ padding:.48rem .8rem; border-radius:8px; width:auto !important; }
    .btn-outline{ background:transparent; border:1px solid var(--border); }
    .btn-danger{ background:var(--err); border:1px solid #a3211a; }
    .row .btn, .row button{ width:auto !important; }

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    @media (max-width:980px){ .grid-2{grid-template-columns:1fr} }

    .profile-box{display:flex;align-items:center;gap:1rem;margin-bottom:1rem}
    .profile-avatar{background:var(--border);width:96px;height:96px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;color:var(--brand);flex-shrink:0;overflow:hidden;cursor:pointer;border:1px solid var(--border)}
    .profile-avatar img{width:100%;height:100%;object-fit:cover}

    .section-title{margin-top:.25rem;font-size:1.1rem;font-weight:600;border-bottom:1px solid var(--border);padding-bottom:.3rem;margin-bottom:.8rem}
    .row.align-right{display:grid;grid-template-columns:1fr 2fr;gap:.75rem 1rem;align-items:center}
    .row.align-right.compact input, .w-compact{max-width:420px}

    .muted{color:var(--muted)}
    .meta{display:grid;grid-template-columns:auto 1fr;gap:.4rem 1rem;margin-top:.5rem}
    .meta label{color:var(--muted)}
    input.copyable{cursor:pointer; user-select:all}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:var(--panel);border:1px solid var(--border);border-radius:10px;max-width:420px;width:92%;padding:1rem}
    .modal h3{margin:.2rem 0 1rem}
    .modal .row{display:grid;grid-template-columns:1fr;gap:.5rem}
    .modal .actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.8rem}
    .ava-fallback{display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-weight:700}
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="brand"><img src="assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="index.html">Info</a>
      <a href="upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="feedback.html" id="nav-feedback" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" aria-current="page" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1>M≈Øj √∫ƒçet</h1>

    <div class="grid-2">
      <div class="card">
        <div class="profile-box">
          <div id="avatarFrame" class="frame">
            <div class="profile-avatar" id="acc-avatar" title="Klikni pro zmƒõnu avataru"><span id="acc-avatar-letter">üë§</span></div>
          </div>
          <div><h2 id="acc-nickname">U≈æivatel</h2></div>
        </div>

        <input type="file" id="inpAvatar" accept="image/png,image/jpeg" style="display:none"/>

        <div class="row align-right compact">
          <label for="inpNickname" style="align-self:flex-start;">N√°zev √∫ƒçtu</label>
          <input type="text" id="inpNickname" class="w-compact" placeholder="Nap≈ô. Pepa"/>
        </div>

        <div class="row align-right compact">
          <label for="acc-email-ro" style="align-self:flex-start;">E-mail u≈æivatele</label>
          <input id="acc-email-ro" class="w-compact" type="text" disabled/>
        </div>

        <div class="section-title">Viditelnost profilu</div>
        <div class="row align-right compact">
          <label for="selVisibility">Re≈æim</label>
          <select id="selVisibility" class="w-compact">
            <option value="public">Ve≈ôejn√Ω</option>
            <option value="private">Soukrom√Ω</option>
            <option value="link">Jen p≈ôes odkaz</option>
          </select>
        </div>

        <div class="row align-right compact">
          <label>Ve≈ôejn√° URL</label>
          <input id="inpPublicUrl" class="w-compact copyable" type="text" readonly/>
        </div>

        <div class="row align-right compact">
          <label for="selTitles">Titul</label>
          <select id="selTitles" class="w-compact"></select>
        </div>

        <div class="toolbar">
          <button id="btnSaveAll" class="btn">Ulo≈æit zmƒõny</button>
          <button id="btnViewPublic" class="btn btn-outline">Zobrazit ve≈ôejn√Ω profil</button>
          <button id="btnChangePwd" class="btn btn-outline">Zmƒõnit heslo</button>
          <button id="btnLogout" class="btn btn-danger">Odhl√°sit se</button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">N√°hled ve≈ôejn√©ho profilu</div>
        <div class="profile-box" style="margin-bottom:.5rem">
          <div class="profile-avatar" id="prev-avatar-wrap">
            <img id="prev-avatar" alt="avatar" style="display:none" />
            <div id="prev-ava-fb" class="ava-fallback">?</div>
          </div>
          <div>
            <h3 id="prev-name" style="margin:0">‚Äî</h3>
            <div class="muted" id="prev-slug">@‚Äî</div>
            <div class="muted" id="prev-joined">ƒålenem od ‚Äî</div>
          </div>
        </div>

        <div class="section-title" style="margin-top:.8rem">Informace o √∫ƒçtu</div>
        <div class="meta">
          <label>E-mail</label><div id="meta-email">‚Äî</div>
          <label>Datum registrace</label><div id="meta-created">‚Äî</div>
          <label>Nahran√© soubory</label><div id="meta-uploads">‚Äî</div>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer"><small>Spr√°va √∫ƒçtu ‚Ä¢ AnimeCloud</small></footer>

  <div class="modal-backdrop" id="pwdModal">
    <div class="modal">
      <h3>Zmƒõnit heslo</h3>
      <div class="row">
        <input type="password" id="pwd-old" placeholder="Star√© heslo">
        <input type="password" id="pwd-new1" placeholder="Nov√© heslo">
        <input type="password" id="pwd-new2" placeholder="Nov√© heslo znovu">
      </div>
      <div class="actions">
        <button class="btn btn-outline" id="pwd-cancel">Ukonƒçit</button>
        <button class="btn" id="pwd-confirm">Zmƒõnit heslo</button>
      </div>
    </div>
  </div>

  <script src="scripts/app.js"></script>
  <script>
    /* =========================
       NAVBAR & ACCESS GUARD (jen localStorage, ≈æ√°dn√© 401)
       ========================= */
    App.initNavbar?.();
  
    function navFromLocalAuth(){
      const auth   = (App.auth && App.auth()) || {};
      const logged = !!auth.email;
      const $ = (id)=> document.getElementById(id);
      const show = (id, v)=>{ const el=$(id); if(el) el.classList.toggle('hidden', !v); };
  
      show('nav-login',   !logged);
      show('nav-account',  logged);
      show('nav-upload',   logged);
      show('nav-feedback', logged);
      show('nav-admin',    logged && auth.role === 'admin');
    }
    navFromLocalAuth();
    window.addEventListener('storage', (e)=>{ if(e.key==='animecloud_auth') navFromLocalAuth(); });
  
    // tvrd√° ochrana str√°nky ‚Äì bez vol√°n√≠ na backend
    if(!(App.auth && App.auth() && App.auth().email)){
      location.href = 'login.html';
    }
  
    /* =========================
       Z√ÅKLADY / HELPERY
       ========================= */
    const a      = App.auth() || {};
    const token  = a?.token || null;
    const email  = a?.email || '';
    const CLOUD_BASE = window.CLOUD_BASE || 'https://storage.googleapis.com/anime-cloud';
  
    const $ = (id)=> document.getElementById(id);
    const ddmmyyyy = (iso)=>{
      if(!iso) return '‚Äî';
      const d = new Date(iso);
      return String(d.getDate()).padStart(2,'0')+'.'+String(d.getMonth()+1).padStart(2,'0')+'.'+d.getFullYear();
    };
  
    // do UI hned
    $('acc-email-ro').value       = email;
    $('meta-email').textContent   = email;
    $('meta-uploads').textContent = String(App.userUploadCount(email));
  
    // Letter-avatar jako dataURL (pro preview fallback)
    function letterAvatar(letter='?'){
      const L = (letter||'?').toUpperCase();
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="96" height="96">
        <rect width="100%" height="100%" rx="48" ry="48" fill="#2a2d3a"/>
        <text x="50%" y="55%" text-anchor="middle" font-size="42" fill="#8e90ff" font-family="system-ui,Arial">${L}</text>
      </svg>`;
      return 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svg);
    }
  
    // zobrazen√≠ (zkr√°cen√©) ve≈ôejn√© URL do inputu + plnou URL do datasetu pro copy
    function setPublicUrl(origin, slug){
      const full = origin + '/u/' + slug;
      const short = origin.replace(/^https?:\/\/[^/]+/i,'http://x') + '/u/' + slug;
      $('inpPublicUrl').value = short;
      $('inpPublicUrl').dataset.full = full;
    }
    // click-to-copy
    async function copyText(text){
      try{ await navigator.clipboard.writeText(text); App.toast('URL zkop√≠rov√°na','ok'); }
      catch{
        const t=document.createElement('input');
        t.value=text; t.style.position='fixed'; t.style.opacity=0; document.body.appendChild(t);
        t.select(); document.execCommand('copy'); t.remove(); App.toast('URL zkop√≠rov√°na','ok');
      }
    }
    $('inpPublicUrl').addEventListener('click', ()=> copyText($('inpPublicUrl').dataset.full || $('inpPublicUrl').value));
  
    // tituly uzamƒçen√©/odemƒçen√© podle miln√≠k≈Ø
    function buildTitles(unlocked){
      const all = ['Veter√°n (10+)', 'Mistr Uploader (50+)', 'Legenda (100+)'];
      const sel = $('selTitles');
      sel.innerHTML = '<option value="">‚Äî ≈æ√°dn√Ω ‚Äî</option>' + all.map(t=>{
        const ok = unlocked.includes(t);
        return `<option value="${t}" ${ok?'':'disabled'}>${t}${ok?'':' (zamƒçeno)'}</option>`;
      }).join('');
    }
    buildTitles(App.unlockedTitles(email));
  
    // avatar fallback na druhou p≈ô√≠ponu
    function addAvatarFallback(imgEl){
      imgEl.onerror = ()=>{
        const base = (imgEl.getAttribute('data-base') || imgEl.src).split('?')[0];
        const isPng = /\.png$/i.test(base);
        const alt = base.replace(/\.(png|jpe?g)$/i, isPng ? '.jpg' : '.png');
        imgEl.onerror = ()=>{ imgEl.src = letterAvatar(email[0]); };
        imgEl.setAttribute('data-base', alt);
        imgEl.src = alt + `?ts=${Date.now()}`;
      };
    }
  
    let ME   = null;
    let slug = email.split('@')[0];
  
    /* =========================
       NAƒåTEN√ç /api/me?email=...
       ========================= */
    async function loadMe(){
      try{
        const r = await fetch('/api/me?email='+encodeURIComponent(email));
        const j = await r.json();
        if(!r.ok || !j?.me) throw 0;
  
        ME   = j.me;
        slug = ME.slug || slug;
  
        $('inpNickname').value        = ME.display_name || '';
        $('acc-nickname').textContent = ME.display_name || email;
  
        $('selVisibility').value      = (ME.visibility||'private').toLowerCase();
  
        const joined = ME.joined_at || ME.created_at;
        $('meta-created').textContent = joined ? ddmmyyyy(joined) : '‚Äî';
        $('prev-joined').textContent  = 'ƒålenem od ' + (joined ? ddmmyyyy(joined) : '‚Äî');
  
        setPublicUrl(location.origin, encodeURIComponent(slug));
        $('prev-name').textContent = ME.display_name || slug;
        $('prev-slug').textContent = '@' + slug;
  
        const ava = ME.avatar_url || '';
        if(ava){
          const bust = `${ava}?ts=${Date.now()}`;
          $('acc-avatar').innerHTML = `<img id="acc-avatar-img" src="${bust}" data-base="${ava}" alt="avatar">`;
          addAvatarFallback($('acc-avatar-img'));
  
          $('prev-avatar').setAttribute('data-base', ava);
          $('prev-avatar').src = bust;
          addAvatarFallback($('prev-avatar'));
        }else{
          $('acc-avatar-letter').textContent = (email||'?')[0].toUpperCase();
          $('prev-avatar').src = letterAvatar(email[0]);
        }
  
        const tInit = Array.isArray(ME.titles) ? (ME.titles[0]||'') : '';
        if(tInit) $('selTitles').value = tInit;
  
      }catch{
        // fallback: aspo≈à nƒõco z localStorage
        const prof = a.profile || {};
        $('inpNickname').value        = prof.nickname || '';
        $('acc-nickname').textContent = prof.nickname || email;
  
        const created = a.created_at || a.joined_at || null;
        $('meta-created').textContent = created ? ddmmyyyy(created) : '‚Äî';
        $('prev-joined').textContent  = 'ƒålenem od ' + (created ? ddmmyyyy(created) : '‚Äî');
  
        setPublicUrl(location.origin, encodeURIComponent(slug));
        $('prev-name').textContent = prof.nickname || slug;
        $('prev-slug').textContent = '@' + slug;
  
        if(prof.avatar){
          $('acc-avatar').innerHTML = `<img id="acc-avatar-img" src="${prof.avatar}" alt="avatar">`;
          $('prev-avatar').src = prof.avatar;
        }else{
          $('acc-avatar-letter').textContent = (email||'?')[0].toUpperCase();
          $('prev-avatar').src = letterAvatar(email[0]);
        }
      }
    }
    loadMe();
  
    /* =========================
       AVATAR: v√Ωbƒõr + n√°hled
       ========================= */
    $('acc-avatar').addEventListener('click', ()=> $('inpAvatar').click());
    let avatarFile = null;
    $('inpAvatar').addEventListener('change', ()=>{
      const f = $('inpAvatar').files[0];
      if(!f) return;
      if(!/^image\/(png|jpe?g)$/i.test(f.type)){ App.toast('Podporujeme PNG/JPEG','error'); return; }
      if(f.size > 2*1024*1024){ App.toast('Obr√°zek je vƒõt≈°√≠ ne≈æ 2 MB','error'); return; }
      avatarFile = f;
      const r=new FileReader();
      r.onload = ()=>{
        const u=r.result;
        $('acc-avatar').innerHTML = `<img id="acc-avatar-img" src="${u}" alt="avatar">`;
        $('prev-avatar').src = u;
      };
      r.readAsDataURL(f);
    });
  
    // live n√°hled jm√©na
    $('inpNickname').addEventListener('input', ()=>{
      const v = $('inpNickname').value.trim();
      const name = v || (ME?.display_name) || email;
      $('acc-nickname').textContent = name;
      $('prev-name').textContent    = name;
    });
  
    /* =========================
       VIDITELNOST
       ========================= */
    $('selVisibility').addEventListener('change', async (e)=>{
      const body = JSON.stringify({ visibility: e.target.value });
      const hdrs = {'Content-Type':'application/json'};
      try{
        // preferovan√©
        let r = await fetch('/api/me/visibility?email='+encodeURIComponent(email),{method:'POST',headers:hdrs,body});
        if(!r.ok){
          // fallback star≈°√≠ n√°zev
          r = await fetch('/api/me/profile_visibility?email='+encodeURIComponent(email),{method:'POST',headers:hdrs,body});
        }
        const j = await r.json().catch(()=> ({}));
        if(!r.ok || !j?.ok) throw 0;
        App.toast('Viditelnost ulo≈æena','ok');
      }catch{
        App.toast('Chyba p≈ôi ukl√°d√°n√≠ viditelnosti','error');
      }
    });
  
    /* =========================
       UPLOAD DO GCS (signed PUT ‚Üí multipart fallback)
       ========================= */
    function buildAvatarUrl(email, ext){
      const emailEnc = encodeURIComponent(email.toLowerCase());
      return `${CLOUD_BASE}/private/avatars/${emailEnc}.${ext}`;
    }
    async function signAndUploadToGCS(file, email){
      const ext = /png$/i.test(file.type) ? 'png' : 'jpg';
      const dst = `private/avatars/${email.toLowerCase()}.${ext}`; // objekt v bucketu (s '@')
      // 1) zkus signed PUT s nƒõkolika variantami kl√≠ƒç≈Ø
      const variants = [
        { path: dst, contentType: file.type },
        { path: dst, content_type: file.type },
        { path: dst, type: file.type }
      ];
      for(const v of variants){
        try{
          const res = await fetch('/upload/sign',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(v)});
          const sj  = await res.json().catch(()=> ({}));
          if(res.ok && (sj.upload_url || sj.signed_url || sj.url)){
            const up = sj.upload_url || sj.signed_url || sj.url;
            const put = await fetch(up,{method:'PUT',headers:{'Content-Type': file.type}, body: file});
            if(!put.ok) throw new Error('PUT selhal');
            return { url: buildAvatarUrl(email, ext), ext };
          }
        }catch{ /* zkus dal≈°√≠ variantu */ }
      }
      // 2) multipart fallback
      const fd = new FormData();
      fd.append('file', file, `avatar.${ext}`);
      fd.append('path', dst);
      const r = await fetch('/upload', { method:'POST', body: fd });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok || !j?.ok) throw new Error(j?.error || 'Upload selhal');
      return { url: buildAvatarUrl(email, ext), ext };
    }
  
    /* =========================
       ULO≈ΩIT ZMƒöNY
       ========================= */
    $('btnSaveAll').addEventListener('click', async ()=>{
      const display_name = $('inpNickname').value.trim();
      const titleVal     = $('selTitles').value || '';
      let   avatar_url   = null;
  
      // 1) avatar ‚Üí GCS
      if(avatarFile){
        try{
          const up = await signAndUploadToGCS(avatarFile, email);
          avatar_url = up.url; // spr√°vn√° URL (email enc, p≈ô√≠pona sed√≠)
        }catch(e){
          App.toast('Nahr√°n√≠ avataru selhalo','error'); return;
        }
      }
  
      // 2) update profilu
      try{
        const payload = { display_name };
        if(avatar_url) payload.avatar_url = avatar_url;
        if(titleVal)   payload.titles = [titleVal];
  
        let r = await fetch('/api/me/update?email='+encodeURIComponent(email),{
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        let j = await r.json().catch(()=> ({}));
        if(!r.ok || !j?.ok) throw new Error(j?.error||'Ulo≈æen√≠ profilu selhalo');
  
        // sync do LS, a≈• avatar/jm√©no ‚Äúz≈Øst√°v√°‚Äù
        try{
          const auth = App.auth() || {};
          auth.profile = { ...(auth.profile||{}),
            display_name: payload.display_name || (ME?.display_name),
            avatar_url:   avatar_url || (ME?.avatar_url),
            titles:       payload.titles || (ME?.titles||[])
          };
          localStorage.setItem('animecloud_auth', JSON.stringify(auth));
        }catch{}
  
        // UI refresh + cache-bust
        const newName = payload.display_name || (ME?.display_name) || email;
        $('acc-nickname').textContent = newName;
        $('prev-name').textContent    = newName;
        if(avatar_url){
          const bust = avatar_url + `?ts=${Date.now()}`;
          $('acc-avatar').innerHTML = `<img id="acc-avatar-img" src="${bust}" data-base="${avatar_url}" alt="avatar">`;
          addAvatarFallback($('acc-avatar-img'));
          $('prev-avatar').setAttribute('data-base', avatar_url);
          $('prev-avatar').src = bust; addAvatarFallback($('prev-avatar'));
        }
  
        App.toast('‚úÖ Profil ulo≈æen','ok');
        avatarFile=null; $('inpAvatar').value='';
  
      }catch(e){
        // legacy fallback (kdyby endpoint zat√≠m nebyl nasazen)
        try{
          if(!token) throw new Error('Chyb√≠ token ‚Äì p≈ôihlas se znovu.');
          const patch={}; if(display_name) patch.nickname=display_name; if(avatar_url) patch.avatar=avatar_url; if(titleVal) patch.secondaryTitle=titleVal;
          const body={ email, token, profile: patch };
          const r=await fetch(App.api('/auth/update_profile'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
          const p=await r.json().catch(()=> ({}));
          if(!r.ok||!p?.ok) throw 0;
          const auth=App.auth()||{}; auth.profile={...(auth.profile||{}),...(p.profile||patch)}; localStorage.setItem('animecloud_auth',JSON.stringify(auth));
          App.toast('‚úÖ Profil ulo≈æen (fallback)','ok');
          avatarFile=null; $('inpAvatar').value='';
        }catch{
          App.toast(e.message || '‚ùå Ulo≈æen√≠ profilu selhalo','error');
        }
      }
    });
  
    // otev≈ô√≠t ve≈ôejn√Ω profil
    $('btnViewPublic').addEventListener('click', ()=>{
      const s = (ME?.slug) || (email.split('@')[0]);
      window.open(`/u/${encodeURIComponent(s)}`,'_blank');
    });
  
    /* =========================
       ZMƒöNA HESLA (modal)
       ========================= */
    const modalOpen  = ()=> $('pwdModal').style.display='flex';
    const modalClose = ()=> $('pwdModal').style.display='none';
    $('btnChangePwd').addEventListener('click', modalOpen);
    $('pwd-cancel').addEventListener('click', modalClose);
    $('pwd-confirm').addEventListener('click', async ()=>{
      const oldp = $('pwd-old').value.trim();
      const new1 = $('pwd-new1').value.trim();
      const new2 = $('pwd-new2').value.trim();
      if(!oldp || !new1 || new1!==new2){ App.toast('Zkontroluj hesla','error'); return; }
  
      try{
        // preferovan√© parametry
        let r = await fetch('/auth/change_password',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, old: oldp, new: new1 })
        });
        if(!r.ok){
          // fallback star≈°√≠ verze
          r = await fetch('/auth/change_password',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ email, old_password: oldp, new_password: new1, token })
          });
        }
        const j = await r.json().catch(()=> ({}));
        if(!r.ok || !j?.ok) throw new Error(j?.error||'Zmƒõna hesla selhala');
  
        App.toast('Heslo bylo zmƒõnƒõno','ok');
        $('pwd-old').value=''; $('pwd-new1').value=''; $('pwd-new2').value='';
        modalClose();
      }catch(e){
        App.toast(e.message || 'Chyba p≈ôi zmƒõnƒõ hesla','error');
      }
    });
  
    // logout
    $('btnLogout').addEventListener('click', ()=> App.logout());
  </script>
</body>
</html>


