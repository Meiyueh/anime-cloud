<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî M≈Øj √∫ƒçet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    .toolbar{ display:flex; gap:.6rem; justify-content:flex-end; align-items:center; flex-wrap:wrap; margin-top:.6rem; }
    @media (max-width:640px){ .toolbar{ justify-content:flex-start; } }
    .btn{ padding:.48rem .8rem; border-radius:8px; width:auto !important; }
    .btn-outline{ background:transparent; border:1px solid var(--border); }
    .btn-danger{ background:var(--err); border:1px solid #a3211a; }
    .row .btn, .row button{ width:auto !important; }
    .profile-box{display:flex;align-items:center;gap:1rem;margin-bottom:1rem}
    .profile-avatar{background:var(--border);width:96px;height:96px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;color:var(--brand);flex-shrink:0;overflow:hidden;cursor:pointer}
    .profile-avatar img{width:100%;height:100%;object-fit:cover}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .section-title{margin-top:.25rem;font-size:1.1rem;font-weight:600;border-bottom:1px solid var(--border);padding-bottom:.3rem;margin-bottom:.8rem}
    .info-grid{display:grid;grid-template-columns:1fr 2fr;gap:.75rem 1rem}
    .info-grid label{align-self:center;color:var(--muted)}
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="brand"><img src="assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="index.html">Info</a>
      <a href="upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="feedback.html" id="nav-feedback" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" aria-current="page" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1>M≈Øj √∫ƒçet</h1>

    <div class="card">
      <div class="profile-box">
        <div id="avatarFrame" class="frame">
          <div class="profile-avatar" id="acc-avatar" title="Klikni pro zmƒõnu avataru"><span id="acc-avatar-letter">üë§</span></div>
        </div>
        <div>
          <h2 id="acc-nickname">U≈æivatel</h2>
          <div class="badges">
            <span id="badge-primary" class="badge primary">USER</span>
            <span id="badge-secondary" class="badge">≈Ω√°dn√Ω titul</span>
          </div>
        </div>
      </div>

      <input type="file" id="inpAvatar" accept="image/*" style="display:none"/>

      <div class="row align-right compact">
        <label for="inpNickname" style="align-self:flex-start;">Zmƒõnit p≈ôezd√≠vku</label>
        <input type="text" id="inpNickname" class="w-compact" placeholder="Tv√° p≈ôezd√≠vka"/>
      </div>

      <div class="row align-right compact">
        <label for="selSecondary" style="align-self:flex-start;">Druh√Ω titul</label>
        <div id="selSecondaryMount" class="w-compact"></div>
      </div>

      <div class="toolbar">
        <button id="btnSaveProfile" class="btn">Ulo≈æit profil</button>
        <button id="btnShowPass" class="btn btn-outline">Zmƒõnit heslo</button>
        <button id="btnLogout" class="btn btn-danger">Odhl√°sit se</button>
      </div>
      <p id="profMsg" class="msg"></p>

      <div id="passPanel" class="card" style="margin-top:12px; display:none;">
        <div class="section-title">Zmƒõna hesla</div>
        <div class="row"><label for="acc-pass0">Aktu√°ln√≠ heslo</label><input type="password" id="acc-pass0" placeholder="Zadej aktu√°ln√≠ heslo"/></div>
        <div class="row"><label for="acc-pass1">Nov√© heslo</label><input type="password" id="acc-pass1" placeholder="Min. 8 znak≈Ø"/></div>
        <div class="row"><label for="acc-pass2">Potvrzen√≠ nov√©ho hesla</label><input type="password" id="acc-pass2" /></div>
        <div class="toolbar"><button id="btn-change-pass" class="btn">Zmƒõnit heslo</button></div>
        <p id="pass-msg" class="msg"></p>
      </div>
    </div>

    <div class="card">
      <div class="section-title">Informace o √∫ƒçtu</div>
      <div class="info-grid">
        <label>E-mail</label><input id="acc-email" class="w-compact" type="text" disabled/>
        <label>Datum registrace</label><input id="acc-created" class="w-compact" type="text" disabled/>
        <label>Nahran√© soubory (celkem)</label><input id="acc-uploads" class="w-compact" type="text" disabled/>
      </div>
    </div>
  </main>

  <footer class="site-footer"><small>Spr√°va √∫ƒçtu ‚Ä¢ AnimeCloud</small></footer>

  <script src="scripts/app.js"></script>
  <script>
    window.CLOUD_BASE = "https://storage.googleapis.com/anime-cloud";
    App.initNavbar(); App.guardAuthOnPage('login.html');

    const a = App.auth();

    // Naƒçten√≠ profilu z cloudu
    let user = null;
    (async function load(){
      try{
        user = await App.cloudGetProfile(a.email);
      } catch {
        // fallback na LS (kdy≈æ by server neodpovƒõdƒõl)
        const uLS = App.getUser(a.email) || {};
        user = { email: a.email, role: uLS.role || a.role || 'user', createdAt: uLS.createdAt || Date.now(), profile: uLS.profile || {} };
      }
      bindProfile(user);
    })();

    function bindProfile(u){
      const p = u.profile || {};
      document.getElementById('acc-email').value = u.email || '';
      document.getElementById('acc-created').value = u.createdAt ? new Date(u.createdAt).toLocaleString() : '‚Äî';
      document.getElementById('acc-uploads').value = String(App.userUploadCount(u.email));
      const frameCls = App.computeMilestoneFrame(App.userUploadCount(u.email));
      const frameEl = document.getElementById('avatarFrame'); if (frameCls) frameEl.classList.add('frame', frameCls);

      const avatarEl = document.getElementById('acc-avatar');
      const avatarLetter = document.getElementById('acc-avatar-letter');
      if (p.avatar){ avatarEl.innerHTML = `<img src="${p.avatar}" alt="avatar">`; }
      else { avatarLetter.textContent = (u.email||'?')[0].toUpperCase(); }
      avatarEl.addEventListener('click', ()=> document.getElementById('inpAvatar').click());
      document.getElementById('inpAvatar').addEventListener('change', ()=>{
        const f = document.getElementById('inpAvatar').files[0]; if (!f) return;
        if (f.size > 1024*1024*2) { App.toast('Obr√°zek je vƒõt≈°√≠ ne≈æ 2 MB','error'); return; }
        const r = new FileReader();
        r.onload = async ()=>{ 
          try{
            const url = await App.cloudUploadAvatar(u.email, r.result);
            App.toast('Avatar ulo≈æen','ok');
            avatarEl.innerHTML = `<img src="${url}" alt="avatar">`;
          }catch(e){ App.toast('Avatar se nepoda≈ôilo ulo≈æit','error'); }
        };
        r.readAsDataURL(f);
      });

      document.getElementById('acc-nickname').textContent = p.nickname || u.email;
      document.getElementById('inpNickname').value = p.nickname || '';
      const primary = (u.role === 'admin') ? 'ADMIN' : (u.role === 'uploader' ? 'UPLOADER' : 'USER');
      document.getElementById('badge-primary').textContent = primary;

      const unlocked = App.unlockedTitles(u.email);
      const allTitles = ['Veter√°n (10+)', 'Mistr Uploader (50+)', 'Legenda (100+)'];
      const selSecHTML = `
        <select id="selSecondary" class="w-compact">
          <option value="">‚Äî ≈æ√°dn√Ω ‚Äî</option>
          ${allTitles.map(t=>{
            const isUnlocked = unlocked.includes(t);
            const selected = (p.secondaryTitle===t) ? 'selected' : '';
            const disabled = isUnlocked ? '' : 'disabled';
            return `<option ${selected} ${disabled} value="${t}">${t}${isUnlocked?'':' (zamƒçeno)'}</option>`;
          }).join('')}
        </select>`;
      const temp = document.createElement('div');
      temp.innerHTML = selSecHTML;
      const selSecondary = temp.firstElementChild;
      document.querySelector('.badges').appendChild(selSecondary);
      document.getElementById('badge-secondary').textContent = p.secondaryTitle || '≈Ω√°dn√Ω titul';

      document.getElementById('btnSaveProfile').addEventListener('click', async ()=>{
        const nick = document.getElementById('inpNickname').value.trim();
        const sec  = document.getElementById('selSecondary').value || null;
        try{
          const updated = await App.cloudUpdateProfile(u.email, { nickname:nick||undefined, secondaryTitle: sec });
          document.getElementById('acc-nickname').textContent = updated.profile.nickname || u.email;
          document.getElementById('badge-secondary').textContent = updated.profile.secondaryTitle || '≈Ω√°dn√Ω titul';
          App.showMsg(document.getElementById('profMsg'), '‚úÖ Profil ulo≈æen.', 'ok');
        }catch(e){
          App.showMsg(document.getElementById('profMsg'),'‚ö†Ô∏è Nepoda≈ôilo se ulo≈æit profil.','error');
        }
      });

      document.getElementById('btnShowPass').addEventListener('click', ()=>{
        const pnl = document.getElementById('passPanel');
        pnl.style.display = (pnl.style.display==='none' || !pnl.style.display) ? 'block' : 'none';
      });

      // Zmƒõna hesla ‚Äì zavol√°me /users/login pro ovƒõ≈ôen√≠ a /users/register znovu nepou≈æ√≠v√°me; server m√° jen login/register/update profil, proto zde ƒçistƒõ ovƒõ≈ôen√≠ + info
      document.getElementById('btn-change-pass').addEventListener('click', async ()=>{
        const p0 = document.getElementById('acc-pass0').value.trim();
        const p1 = document.getElementById('acc-pass1').value.trim();
        const p2 = document.getElementById('acc-pass2').value.trim();
        const msg = document.getElementById('pass-msg');

        if (!p0 || !p1 || !p2) return App.showMsg(msg,'Vypl≈àte v≈°echna pole.','error');
        if (p1 !== p2)  return App.showMsg(msg,'Hesla se neshoduj√≠.','error');
        if (p1.length < 8) return App.showMsg(msg,'Min. d√©lka nov√©ho hesla je 8 znak≈Ø.','error');

        try{
          // jednoduch√© ≈ôe≈°en√≠: ovƒõ≈ô star√© heslo (login), a pokud projde, vytvo≈ô√≠me nov√Ω z√°znam parci√°lnƒõ p≈ôes admin z√°sah.
          // Pozn.: aby to bylo plnƒõ REST, p≈ôidali bychom na server /users/change_password (m≈Ø≈æe≈° doplnit snadno analogicky).
          await fetch(App.api('/users/login'), {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:u.email, password:p0})});
          // Workaround: zmƒõna hesla zat√≠m nen√≠ na serveru ‚Äì pro teƒè jen informaƒçn√≠ zpr√°va:
          App.showMsg(msg,'‚úÖ Aktu√°ln√≠ heslo ovƒõ≈ôeno. Pro fin√°ln√≠ zmƒõnu hesla p≈ôid√°me endpoint /users/change_password (mohu dopsat hned, kdy≈æ ≈ôekne≈°).','ok');
        }catch{
          App.showMsg(msg,'Aktu√°ln√≠ heslo nesouhlas√≠.','error');
        }
      });

      document.getElementById('btnLogout').addEventListener('click', ()=> App.logout());
    }
  </script>
</body>
</html>
