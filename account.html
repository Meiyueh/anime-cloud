<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî M≈Øj √∫ƒçet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    /* zachov√°v√° p≈Øvodn√≠ styly + drobn√© dopl≈àky */
    .toolbar{display:flex;gap:.6rem;justify-content:flex-end;align-items:center;flex-wrap:wrap;margin-top:.6rem}
    @media (max-width:640px){ .toolbar{ justify-content:flex-start; } }
    .btn{ padding:.48rem .8rem; border-radius:8px; width:auto !important; }
    .btn-outline{ background:transparent; border:1px solid var(--border); }
    .btn-danger{ background:var(--err); border:1px solid #a3211a; }
    .row .btn, .row button{ width:auto !important; }

    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    @media (max-width:980px){ .grid-2{grid-template-columns:1fr} }

    .profile-box{display:flex;align-items:center;gap:1rem;margin-bottom:1rem}
    .profile-avatar{background:var(--border);width:96px;height:96px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;color:var(--brand);flex-shrink:0;overflow:hidden;cursor:pointer}
    .profile-avatar img{width:100%;height:100%;object-fit:cover}

    .section-title{margin-top:.25rem;font-size:1.1rem;font-weight:600;border-bottom:1px solid var(--border);padding-bottom:.3rem;margin-bottom:.8rem}
    .row.align-right{display:grid;grid-template-columns:1fr 2fr;gap:.75rem 1rem;align-items:center}
    .row.align-right.compact input, .w-compact{max-width:420px}

    .muted{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .55rem;border:1px solid var(--border);border-radius:999px}
    .meta{display:grid;grid-template-columns:auto 1fr;gap:.4rem 1rem;margin-top:.5rem}
    .meta label{color:var(--muted)}
    code.copyable{cursor:pointer; user-select:all}
  </style>
</head>
<body>
  <!-- TOPBAR (p≈Øvodn√≠) -->
  <header class="site-header">
    <a href="index.html" class="brand"><img src="assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="index.html">Info</a>
      <a href="upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="feedback.html" id="nav-feedback" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" aria-current="page" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1>M≈Øj √∫ƒçet</h1>

    <div class="grid-2">
      <!-- LEV√Å KARTA: PROFIL + VIDITELNOST + TLAƒå√çTKA -->
      <div class="card">
        <div class="profile-box">
          <div id="avatarFrame" class="frame">
            <div class="profile-avatar" id="acc-avatar" title="Klikni pro zmƒõnu avataru"><span id="acc-avatar-letter">üë§</span></div>
          </div>
          <div>
            <h2 id="acc-nickname">U≈æivatel</h2>
          </div>
        </div>

        <input type="file" id="inpAvatar" accept="image/png,image/jpeg" style="display:none"/>

        <div class="row align-right compact">
          <label for="inpNickname" style="align-self:flex-start;">N√°zev √∫ƒçtu</label>
          <input type="text" id="inpNickname" class="w-compact" placeholder="Nap≈ô. Pepa"/>
        </div>

        <div class="row align-right compact">
          <label for="acc-email-ro" style="align-self:flex-start;">E-mail u≈æivatele</label>
          <input id="acc-email-ro" class="w-compact" type="text" disabled/>
        </div>

        <div class="section-title">Viditelnost profilu</div>
        <div class="row align-right compact">
          <label for="selVisibility">Re≈æim</label>
          <select id="selVisibility" class="w-compact">
            <option value="public">Ve≈ôejn√Ω</option>
            <option value="private">Soukrom√Ω</option>
            <option value="link">Jen p≈ôes odkaz</option>
          </select>
        </div>
        <div class="row align-right compact">
          <label>Ve≈ôejn√° URL</label>
          <div style="display:flex;gap:.5rem;align-items:center">
            <input id="inpPublicUrl" class="w-compact" type="text" readonly/>
            <button id="btnCopyUrl" class="btn btn-outline">Kop√≠rovat</button>
          </div>
        </div>

        <!-- Tituly (v√Ωbƒõrov√© menu s uzamƒçen√Ωmi polo≈ækami) -->
        <div class="row align-right compact">
          <label for="selTitles">Tituly</label>
          <select id="selTitles" class="w-compact">
            <!-- pln√≠ se dynamicky podle miln√≠k≈Ø -->
          </select>
        </div>

        <div class="toolbar">
          <button id="btnSaveAll" class="btn">Ulo≈æit zmƒõny</button>
          <button id="btnViewPublic" class="btn btn-outline">Zobrazit ve≈ôejn√Ω profil</button>
          <button id="btnChangePwd" class="btn btn-outline">Zmƒõnit heslo</button>
          <button id="btnLogout" class="btn btn-danger">Odhl√°sit se</button>
        </div>
        <p id="profMsg" class="msg"></p>
      </div>

      <!-- PRAV√Å KARTA: N√ÅHLED VE≈òEJN√âHO PROFILU + INFO -->
      <div class="card">
        <div class="section-title">N√°hled ve≈ôejn√©ho profilu</div>
        <div class="profile-box" style="margin-bottom:.5rem">
          <div class="profile-avatar"><img id="prev-avatar" alt="avatar" /></div>
          <div>
            <h3 id="prev-name" style="margin:0">‚Äî</h3>
            <div class="muted" id="prev-slug">@‚Äî</div>
            <div class="muted" id="prev-joined">ƒålenem od ‚Äî</div>
          </div>
        </div>

        <div class="row" style="gap:1rem;margin-bottom:.8rem">
          <div class="chip"><small class="muted">Ve≈ôejn√Ω URL</small>&nbsp;<code id="prev-url" class="copyable">‚Äî</code></div>
        </div>

        <!-- p≈ôesunut√© informace o √∫ƒçtu -->
        <div class="section-title" style="margin-top:.8rem">Informace o √∫ƒçtu</div>
        <div class="meta">
          <label>E-mail</label><div id="meta-email">‚Äî</div>
          <label>Datum registrace</label><div id="meta-created">‚Äî</div>
          <label>Nahran√© soubory</label><div id="meta-uploads">‚Äî</div>
        </div>
      </div>
    </div>
  </main>

  <!-- BOTTOMBAR (p≈Øvodn√≠) -->
  <footer class="site-footer"><small>Spr√°va √∫ƒçtu ‚Ä¢ AnimeCloud</small></footer>

  <script src="scripts/app.js"></script>
  <script>
    App.initNavbar(); App.guardAuthOnPage('login.html');

    const a = App.auth() || {};
    const token = a?.token || null;
    const email = a?.email || '';
    const ddmmyyyy = iso => {
      if(!iso) return '‚Äî';
      const d = new Date(iso);
      const dd=String(d.getDate()).padStart(2,'0');
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const yy=d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    };

    // UI refs
    const avatarEl  = document.getElementById('acc-avatar');
    const avatarLet = document.getElementById('acc-avatar-letter');
    const prevAvatar= document.getElementById('prev-avatar');
    const prevName  = document.getElementById('prev-name');
    const prevSlug  = document.getElementById('prev-slug');
    const prevJoined= document.getElementById('prev-joined');
    const prevUrl   = document.getElementById('prev-url');

    document.getElementById('acc-email-ro').value = email;
    document.getElementById('meta-email').textContent = email;
    document.getElementById('meta-uploads').textContent = String(App.userUploadCount(email));

    // tituly ‚Äî p≈ôiprav options (uzamƒçen√© = disabled)
    function buildTitles(unlocked){
      const all = [
        'Veter√°n (10+)',
        'Mistr Uploader (50+)',
        'Legenda (100+)',
      ];
      const sel = document.getElementById('selTitles');
      sel.innerHTML = '<option value="">‚Äî ≈æ√°dn√Ω ‚Äî</option>' + all.map(t=>{
        const dis = unlocked.includes(t) ? '' : ' disabled';
        const label = unlocked.includes(t) ? t : `${t} (zamƒçeno)`;
        return `<option value="${t}"${dis}>${label}</option>`;
      }).join('');
    }
    buildTitles(App.unlockedTitles(email));

    // naƒçti /api/me (nov√Ω backend), jinak fallback na LS z loginu
    let ME = null, slug = email.split('@')[0];
    (async ()=>{
      try{
        const r = await fetch('/api/me');
        const j = await r.json();
        const me = j?.me || j?.user;
        if(!r.ok || !me) throw 0;
        ME = me; slug = me.slug || slug;

        // vypl≈à UI
        document.getElementById('inpNickname').value = me.display_name || '';
        document.getElementById('acc-nickname').textContent = me.display_name || email;

        const ava = me.avatar_url || '';
        if(ava){ avatarEl.innerHTML = `<img src="${ava}" alt="avatar">`; prevAvatar.src = ava; }
        else { avatarLet.textContent = (email||'?')[0].toUpperCase(); }

        const v = (me.visibility || 'private').toLowerCase();
        document.getElementById('selVisibility').value = v;

        const joined = me.joined_at || me.created_at;
        prevJoined.textContent = 'ƒålenem od ' + (joined ? ddmmyyyy(joined) : '‚Äî');
        document.getElementById('meta-created').textContent = joined ? ddmmyyyy(joined) : '‚Äî';

        prevName.textContent = me.display_name || slug;
        prevSlug.textContent = '@' + (me.slug || slug);

        const pubUrl = `${location.origin}/u/${encodeURIComponent(me.slug || slug)}`;
        document.getElementById('inpPublicUrl').value = pubUrl;
        prevUrl.textContent = pubUrl;

        // p≈ôedvybrat titul kdy≈æ existuje
        const tInit = Array.isArray(me.titles) ? (me.titles[0] || '') : (me.title || '');
        if (tInit) document.getElementById('selTitles').value = tInit;

      }catch{
        // fallback z LS
        const prof = a.profile || {};
        document.getElementById('inpNickname').value = prof.nickname || '';
        document.getElementById('acc-nickname').textContent = prof.nickname || email;

        if(prof.avatar){ avatarEl.innerHTML = `<img src="${prof.avatar}" alt="avatar">`; prevAvatar.src = prof.avatar; }
        else { avatarLet.textContent = (email||'?')[0].toUpperCase(); }

        prevName.textContent = prof.nickname || slug;
        prevSlug.textContent = '@' + slug;

        const pubUrl = `${location.origin}/u/${encodeURIComponent(slug)}`;
        document.getElementById('inpPublicUrl').value = pubUrl;
        prevUrl.textContent = pubUrl;
      }
    })();

    // klik na avatar => otev≈ô√≠t file dialog
    avatarEl.addEventListener('click', ()=> document.getElementById('inpAvatar').click());
    let avatarFile = null;
    document.getElementById('inpAvatar').addEventListener('change', ()=>{
      const f = document.getElementById('inpAvatar').files[0];
      if(!f) return;
      if(!/^image\/(png|jpeg)$/.test(f.type)){ App.toast('Podporujeme PNG/JPEG','error'); return; }
      if(f.size > 2*1024*1024){ App.toast('Obr√°zek je vƒõt≈°√≠ ne≈æ 2 MB','error'); return; }
      avatarFile = f;
      const r = new FileReader();
      r.onload = ()=>{ avatarEl.innerHTML = `<img src="${r.result}" alt="avatar">`; prevAvatar.src = r.result; };
      r.readAsDataURL(f);
    });

    // live preview jm√©na
    document.getElementById('inpNickname').addEventListener('input', ()=>{
      const v = document.getElementById('inpNickname').value.trim();
      document.getElementById('acc-nickname').textContent = v || (ME?.display_name) || email;
      prevName.textContent = document.getElementById('acc-nickname').textContent;
    });

    // kop√≠rov√°n√≠ ve≈ôejn√© URL ‚Äî klik na pole i na tlaƒç√≠tko
    async function copyPublicUrl(){
      try{
        const v = document.getElementById('inpPublicUrl').value;
        await navigator.clipboard.writeText(v);
        App.toast('URL zkop√≠rov√°na','ok');
      }catch{ App.toast('Nepoda≈ôilo se zkop√≠rovat','error'); }
    }
    document.getElementById('btnCopyUrl').addEventListener('click', copyPublicUrl);
    document.getElementById('inpPublicUrl').addEventListener('click', copyPublicUrl);
    prevUrl.addEventListener('click', copyPublicUrl);

    // zmƒõna viditelnosti ‚Äî ulo≈æ√≠me okam≈æitƒõ (pokud /api/me existuje)
    document.getElementById('selVisibility').addEventListener('change', async (e)=>{
      if(!ME) return;
      try{
        const r = await fetch('/api/me/profile_visibility', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ visibility: e.target.value })
        });
        if(!r.ok) throw 0;
        App.toast('Viditelnost ulo≈æena','ok');
      }catch{ App.toast('Chyba p≈ôi ukl√°d√°n√≠ viditelnosti','error'); }
    });

    // SAVE: avatar upload (+ fallback), jm√©no, titul
    document.getElementById('btnSaveAll').addEventListener('click', async ()=>{
      const display_name = document.getElementById('inpNickname').value.trim();
      const titleVal = document.getElementById('selTitles').value || '';
      let avatar_url = null;

      // 1) nahr√°t avatar (pokud vybr√°n)
      if(avatarFile){
        try{
          const ext = avatarFile.type === 'image/png' ? 'png' : 'jpg';
          const s = (ME?.slug || email.split('@')[0]);
          const dst = `avatars/${s}.${ext}`;

          // a) p≈ô√≠m√Ω /upload
          const fd = new FormData();
          fd.append('file', avatarFile, `${s}.${ext}`);
          fd.append('path', dst);
          fd.append('kind', 'avatar');
          let up = await fetch('/upload', { method:'POST', body: fd });
          let uj = await up.json().catch(()=> ({}));

          // b) fallback: /upload/sign + PUT
          if(!up.ok){
            const sign = await fetch('/upload/sign', {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ path: dst, content_type: avatarFile.type })
            });
            const sj = await sign.json();
            if(!sign.ok || !sj?.upload_url){ throw new Error(uj?.error || 'Upload selhal'); }
            await fetch(sj.upload_url, { method:'PUT', headers:{'Content-Type': avatarFile.type}, body: avatarFile });
            avatar_url = sj.public_url || `/${dst}`;
          }else{
            avatar_url = uj?.url || uj?.public_url || `/${dst}`;
          }
        }catch(e){ App.toast('Nahr√°n√≠ avataru selhalo','error'); return; }
      }

      // 2) ulo≈æen√≠ profilu (preferenƒçnƒõ /api/me/update)
      if(ME){
        try{
          const payload = { display_name };
          if (avatar_url) payload.avatar_url = avatar_url;
          if (titleVal) payload.titles = [titleVal];

          const r = await fetch('/api/me/update', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const j = await r.json().catch(()=> ({}));
          if(!r.ok){ throw new Error(j?.error||'Ulo≈æen√≠ profilu selhalo'); }

          ME = j.me || ME;
          if(avatar_url){ prevAvatar.src = avatar_url + `?ts=${Date.now()}`; }
          document.getElementById('acc-nickname').textContent = ME.display_name || display_name || email;
          prevName.textContent = document.getElementById('acc-nickname').textContent;

          App.showMsg(document.getElementById('profMsg'), '‚úÖ Profil ulo≈æen.', 'ok');
          avatarFile = null; document.getElementById('inpAvatar').value = '';
          return;
        }catch(e){
          // spadne -> zkus√≠me star√Ω fallback
        }
      }

      // 3) fallback: /auth/update_profile + LS
      try{
        if(!token){ App.toast('Chyb√≠ token ‚Äì p≈ôihlas se znovu.','error'); return; }
        const patch = {};
        if(display_name) patch.nickname = display_name;
        if(avatar_url)   patch.avatar   = avatar_url;
        if(titleVal)     patch.secondaryTitle = titleVal;

        const body = { email, token, profile: patch };
        const r = await fetch(App.api('/auth/update_profile'), {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const p = await r.json().catch(()=> ({}));
        if(!r.ok || !p?.ok){ throw 0; }

        const auth = App.auth() || {};
        auth.profile = { ...(auth.profile||{}), ...(p.profile||patch) };
        localStorage.setItem('animecloud_auth', JSON.stringify(auth));
        App.showMsg(document.getElementById('profMsg'), '‚úÖ Profil ulo≈æen (fallback).', 'ok');
        avatarFile = null; document.getElementById('inpAvatar').value = '';
      }catch{
        App.showMsg(document.getElementById('profMsg'), '‚ùå Ulo≈æen√≠ profilu selhalo.', 'err');
      }
    });

    // akce tlaƒç√≠tek
    document.getElementById('btnViewPublic').addEventListener('click', ()=>{
      const s = (ME?.slug) || (email.split('@')[0]);
      window.open(`${location.origin}/u/${encodeURIComponent(s)}`, '_blank');
    });
    document.getElementById('btnChangePwd').addEventListener('click', ()=> location.href = '/change-password.html');
    document.getElementById('btnLogout').addEventListener('click', ()=> App.logout());
  </script>
</body>
</html>
