<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî M≈Øj √∫ƒçet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    .toolbar{
      display:flex;gap:.6rem;justify-content:flex-end;align-items:center;flex-wrap:wrap;margin-top:.6rem;
    }
    @media (max-width:640px){ .toolbar{ justify-content:flex-start; } }
    .btn{ padding:.48rem .8rem; border-radius:8px; width:auto !important; }
    .btn-outline{ background:transparent; border:1px solid var(--border); }
    .btn-danger{ background:var(--err); border:1px solid #a3211a; }
    .row .btn, .row button{ width:auto !important; }

    .profile-box{display:flex;align-items:center;gap:1rem;margin-bottom:1rem}
    .profile-avatar{background:var(--border);width:96px;height:96px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;color:var(--brand);flex-shrink:0;overflow:hidden;cursor:pointer}
    .profile-avatar img{width:100%;height:100%;object-fit:cover}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .section-title{margin-top:.25rem;font-size:1.1rem;font-weight:600;border-bottom:1px solid var(--border);padding-bottom:.3rem;margin-bottom:.8rem}
    .info-grid{display:grid;grid-template-columns:1fr 2fr;gap:.75rem 1rem}
    .info-grid label{align-self:center;color:var(--muted)}
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="brand"><img src="assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="index.html">Info</a>
      <a href="upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="feedback.html" id="nav-feedback" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" aria-current="page" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1>M≈Øj √∫ƒçet</h1>

    <div class="card">
      <div class="profile-box">
        <div id="avatarFrame" class="frame">
          <div class="profile-avatar" id="acc-avatar" title="Klikni pro zmƒõnu avataru"><span id="acc-avatar-letter">üë§</span></div>
        </div>
        <div>
          <h2 id="acc-nickname">U≈æivatel</h2>
          <div class="badges">
            <span id="badge-primary" class="badge primary">USER</span>
            <span id="badge-secondary" class="badge">≈Ω√°dn√Ω titul</span>
          </div>
        </div>
      </div>

      <input type="file" id="inpAvatar" accept="image/*" style="display:none"/>

      <div class="row align-right compact">
        <label for="inpNickname" style="align-self:flex-start;">Zmƒõnit p≈ôezd√≠vku</label>
        <input type="text" id="inpNickname" class="w-compact" placeholder="Tv√° p≈ôezd√≠vka"/>
      </div>

      <!-- V√Ωbƒõr druh√©ho titulu -->
      <div class="row align-right compact">
        <label for="selSecondary" style="align-self:flex-start;">Druh√Ω titul</label>
        <select id="selSecondary" class="w-compact">
          <option value="">‚Äî ≈æ√°dn√Ω ‚Äî</option>
          <option value="Veter√°n (10+)">Veter√°n (10+)</option>
          <option value="Mistr Uploader (50+)">Mistr Uploader (50+)</option>
          <option value="Legenda (100+)">Legenda (100+)</option>
        </select>
      </div>

      <div class="toolbar">
        <button id="btnSaveProfile" class="btn">Ulo≈æit profil</button>
        <button id="btnLogout" class="btn btn-danger">Odhl√°sit se</button>
      </div>
      <p id="profMsg" class="msg"></p>
    </div>

    <div class="card">
      <div class="section-title">Informace o √∫ƒçtu</div>
      <div class="info-grid">
        <label>E-mail</label><input id="acc-email" class="w-compact" type="text" disabled/>
        <label>Datum registrace</label><input id="acc-created" class="w-compact" type="text" disabled/>
        <label>Nahran√© soubory (celkem)</label><input id="acc-uploads" class="w-compact" type="text" disabled/>
      </div>
    </div>
  </main>

  <footer class="site-footer"><small>Spr√°va √∫ƒçtu ‚Ä¢ AnimeCloud</small></footer>

  <script src="scripts/app.js"></script>
  <script>
    window.CLOUD_BASE = "https://storage.googleapis.com/anime-cloud";
    App.initNavbar(); App.guardAuthOnPage('login.html');

    // auth objekt s tokenem a profilem z /auth/login
    const a = App.auth();
    const token = a?.token || null;

    // Z√°kladn√≠ info
    document.getElementById('acc-email').value = a.email || '';
    document.getElementById('acc-created').value = '‚Äî'; // createdAt zat√≠m nepos√≠l√°me ze serveru
    document.getElementById('acc-uploads').value = String(App.userUploadCount(a.email));

    // Primary badge
    const primary = (a.role === 'admin') ? 'ADMIN' : (a.role === 'uploader' ? 'UPLOADER' : 'USER');
    document.getElementById('badge-primary').textContent = primary;

    // Sekund√°rn√≠ tituly ‚Äì uzamƒçen√≠ podle upload≈Ø
    const unlocked = App.unlockedTitles(a.email);
    Array.from(document.getElementById('selSecondary').options).forEach(opt=>{
      if (!opt.value) return;
      if (!unlocked.includes(opt.value)) { opt.disabled = true; opt.textContent = opt.textContent + ' (zamƒçeno)'; }
    });

    // Profil z auth.profile (ulo≈æen√Ω p≈ôi loginu)
    const profile = (a.profile || {});
    const avatarEl = document.getElementById('acc-avatar');
    const avatarLetter = document.getElementById('acc-avatar-letter');

    // avatar
    if (profile.avatar){
      avatarEl.innerHTML = `<img src="${profile.avatar}" alt="avatar">`;
    } else {
      avatarLetter.textContent = (a.email||'?')[0].toUpperCase();
    }
    avatarEl.addEventListener('click', ()=> document.getElementById('inpAvatar').click());
    document.getElementById('inpAvatar').addEventListener('change', async ()=>{
      const f = document.getElementById('inpAvatar').files[0]; if (!f) return;
      if (f.size > 1024*1024*2) { App.toast('Obr√°zek je vƒõt≈°√≠ ne≈æ 2 MB','error'); return; }
      const dataUrl = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f); });
      await saveProfile({ avatar: dataUrl });
      avatarEl.innerHTML = `<img src="${dataUrl}" alt="avatar">`;
      App.toast('Avatar ulo≈æen','ok');
    });

    // nick + sekund√°rn√≠ titul do UI
    document.getElementById('acc-nickname').textContent = profile.nickname || a.email;
    document.getElementById('inpNickname').value = profile.nickname || '';
    document.getElementById('badge-secondary').textContent = profile.secondaryTitle || '≈Ω√°dn√Ω titul';
    document.getElementById('selSecondary').value = profile.secondaryTitle || '';

    // r√°meƒçek podle miln√≠ku
    const frameCls = App.computeMilestoneFrame(App.userUploadCount(a.email));
    const frameEl = document.getElementById('avatarFrame'); if (frameCls) frameEl.classList.add('frame', frameCls);

    // Ulo≈æit profil (nickname + secondaryTitle)
    document.getElementById('btnSaveProfile').addEventListener('click', async ()=>{
      const nick = document.getElementById('inpNickname').value.trim();
      const sec  = document.getElementById('selSecondary').value || null;
      await saveProfile({ nickname: nick || null, secondaryTitle: sec });
      document.getElementById('acc-nickname').textContent = nick || (a.profile?.nickname) || a.email;
      document.getElementById('badge-secondary').textContent = sec || '≈Ω√°dn√Ω titul';
      App.showMsg(document.getElementById('profMsg'), '‚úÖ Profil ulo≈æen.', 'ok');
    });

    // Odhl√°≈°en√≠
    document.getElementById('btnLogout').addEventListener('click', ()=> App.logout());

    // === helper: ulo≈æit profil na server (/auth/update_profile) a do LS ===
    async function saveProfile(patch){
      if (!token) { App.toast('Chyb√≠ token ‚Äì znovu se p≈ôihlas.','error'); return; }
      const body = { email: a.email, token, profile: patch };
      try{
        const r = await fetch(App.api('/auth/update_profile'), {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const payload = await r.json().catch(()=> ({}));
        if (!r.ok || !payload?.ok){
          App.toast('Ulo≈æen√≠ profilu selhalo','error'); return;
        }
        // zapi≈° zpƒõt do auth v LS
        const auth = App.auth() || {};
        auth.profile = { ...(auth.profile||{}), ...(payload.profile||{}) };
        localStorage.setItem('animecloud_auth', JSON.stringify(auth));
      } catch {
        App.toast('Chyba p≈ôipojen√≠','error');
      }
    }
  </script>
</body>
</html>
