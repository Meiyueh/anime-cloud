<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>AnimeCloud ‚Äî M≈Øj √∫ƒçet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    .toolbar{display:flex;gap:.6rem;justify-content:flex-end;align-items:center;flex-wrap:wrap;margin-top:.6rem}
    @media (max-width:640px){ .toolbar{ justify-content:flex-start; } }
    .btn{ padding:.48rem .8rem; border-radius:8px; width:auto !important; }
    .btn-danger{ background:var(--err); border:1px solid #a3211a; }
    .profile-box{display:flex;align-items:center;gap:1rem;margin-bottom:1rem}
    .profile-avatar{background:var(--border);width:96px;height:96px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;color:var(--brand);flex-shrink:0;overflow:hidden;cursor:pointer;border:1px solid var(--border)}
    .profile-avatar img{width:100%;height:100%;object-fit:cover}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .section-title{margin-top:.25rem;font-size:1.1rem;font-weight:600;border-bottom:1px solid var(--border);padding-bottom:.3rem;margin-bottom:.8rem}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    code.copyable{cursor:copy}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .modal .box{background:var(--panel);border:1px solid var(--border);border-radius:12px;max-width:460px;width:92%;padding:16px}
    .modal .row{display:flex;gap:.6rem;align-items:center;margin:.35rem 0}
    .modal .row label{min-width:130px}
  </style>
</head>
<body>
  <header class="site-header">
    <a href="index.html" class="brand"><img src="assets/logo.svg" alt="AnimeCloud" /></a>
    <nav class="top-nav">
      <a href="index.html">Info</a>
      <a href="upload.html" id="nav-upload" class="hidden">Upload</a>
      <a href="feedback.html" id="nav-feedback" class="hidden">Feedback</a>
      <a href="account.html" id="nav-account" aria-current="page" class="hidden">√öƒçet</a>
      <a href="login.html" id="nav-login">P≈ôihl√°≈°en√≠</a>
      <a href="admin.html" id="nav-admin" class="hidden">Admin</a>
      <a href="#" id="nav-theme" title="P≈ôepnout t√©ma">üåì</a>
    </nav>
  </header>

  <main class="container">
    <h1>M≈Øj √∫ƒçet</h1>

    <!-- PROFIL -->
    <div class="card">
      <div class="profile-box">
        <div id="avatarFrame" class="frame">
          <div class="profile-avatar" id="acc-avatar" title="Klikni pro zmƒõnu avataru"><span id="acc-avatar-letter">üë§</span></div>
        </div>
        <div>
          <h2 id="acc-nickname">U≈æivatel</h2>
          <div class="badges">
            <span id="badge-primary" class="badge primary">USER</span>
            <span id="badge-secondary" class="badge">≈Ω√°dn√Ω titul</span>
          </div>
        </div>
      </div>
      <input type="file" id="inpAvatar" accept="image/png,image/jpeg" style="display:none"/>

      <!-- N√°zev √∫ƒçtu + e-mail vedle sebe -->
      <div class="row2">
        <div class="row align-right compact">
          <label for="inpNickname" style="align-self:flex-start;">N√°zev √∫ƒçtu</label>
          <input type="text" id="inpNickname" class="w-compact" placeholder="Nap≈ô. Pepa"/>
        </div>
        <div class="row align-right compact">
          <label for="acc-email" style="align-self:flex-start;">E-mail</label>
          <input type="text" id="acc-email" class="w-compact" disabled />
        </div>
      </div>

      <!-- Tituly (odemykan√© miln√≠ky) -->
      <div class="row align-right compact">
        <label for="selSecondary" style="align-self:flex-start;">Titul</label>
        <select id="selSecondary" class="w-compact">
          <option value="">‚Äî ≈æ√°dn√Ω ‚Äî</option>
          <option value="Veter√°n (10+)" data-min="10">Veter√°n (10+)</option>
          <option value="Mistr Uploader (50+)" data-min="50">Mistr Uploader (50+)</option>
          <option value="Legenda (100+)" data-min="100">Legenda (100+)</option>
        </select>
      </div>

      <!-- Viditelnost + ve≈ôejn√° URL (click-to-copy) -->
      <div class="row align-right compact">
        <label>Viditelnost</label>
        <select id="selVisibility" class="w-compact">
          <option value="private">Soukrom√Ω</option>
          <option value="public">Ve≈ôejn√Ω</option>
          <option value="link">Na odkaz</option>
        </select>
      </div>

      <div class="row align-right compact">
        <label>Ve≈ôejn√° URL</label>
        <div class="w-compact">
          <code id="public-url" class="copyable" title="Kliknut√≠m zkop√≠ruje≈°"></code>
        </div>
      </div>

      <div class="toolbar">
        <button id="btnSaveProfile" class="btn">Ulo≈æit profil</button>
        <button id="btnShowPublic" class="btn">Zobrazit ve≈ôejn√Ω profil</button>
        <button id="btnChangePwd"  class="btn">Zmƒõnit heslo</button>
        <button id="btnLogout" class="btn btn-danger">Odhl√°sit se</button>
      </div>
    </div>

    <!-- N√ÅHLED VE≈òEJN√âHO PROFILU -->
    <div class="card">
      <div class="section-title">N√°hled ve≈ôejn√©ho profilu</div>
      <div class="profile-box" style="margin-bottom:.2rem">
        <div class="profile-avatar" id="prev-avatar"><span>üë§</span></div>
        <div>
          <h3 id="prev-name" style="margin:.2rem 0">‚Äî</h3>
          <div class="muted" id="prev-slug">@‚Äî</div>
          <div class="muted" id="prev-joined">ƒålenem od ‚Äî</div>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer"><small>Spr√°va √∫ƒçtu ‚Ä¢ AnimeCloud</small></footer>

  <!-- Modal: zmƒõna hesla -->
  <div id="pwdModal" class="modal" role="dialog" aria-modal="true">
    <div class="box">
      <h3>Zmƒõnit heslo</h3>
      <div class="row"><label>Star√© heslo</label><input type="password" id="pwdOld" class="w-compact" /></div>
      <div class="row"><label>Nov√© heslo</label><input type="password" id="pwdNew1" class="w-compact" /></div>
      <div class="row"><label>Nov√© heslo znovu</label><input type="password" id="pwdNew2" class="w-compact" /></div>
      <div class="toolbar">
        <button id="pwdCancel" class="btn">Ukonƒçit</button>
        <button id="pwdSubmit" class="btn">Zmƒõnit heslo</button>
      </div>
    </div>
  </div>

  <script src="scripts/app.js"></script>
  <script>
    window.CLOUD_BASE = "https://storage.googleapis.com/anime-cloud";
    App.initNavbar(); App.guardAuthOnPage('login.html');

    const a = App.auth() || {};
    const email = a.email;
    const token = a.token;

    const elAvatar     = document.getElementById('acc-avatar');
    const elAvaLetter  = document.getElementById('acc-avatar-letter');
    const elInpAvatar  = document.getElementById('inpAvatar');
    const elNick       = document.getElementById('inpNickname');
    const elEmail      = document.getElementById('acc-email');
    const elSelTitle   = document.getElementById('selSecondary');
    const elSelVis     = document.getElementById('selVisibility');
    const elPubUrl     = document.getElementById('public-url');

    const prevAva  = document.getElementById('prev-avatar');
    const prevName = document.getElementById('prev-name');
    const prevSlug = document.getElementById('prev-slug');
    const prevJoin = document.getElementById('prev-joined');

    function ddmmyyyy(iso){
      if(!iso) return '‚Äî';
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      return `${dd}.${mm}.${d.getFullYear()}`;
    }

    // ====== LOAD ME ======
    async function loadMe(){
      const r = await fetch(`/api/me?email=${encodeURIComponent(email)}`);
      const j = await r.json();
      if(!j.ok){ App.toast('Naƒçten√≠ profilu selhalo','error'); return; }
      const me = j.me || {};

      elEmail.value = email;
      elNick.value  = (me.display_name || '').trim();
      document.getElementById('acc-nickname').textContent = me.display_name || email;

      const primary = (a.role === 'admin') ? 'ADMIN' : (a.role === 'uploader' ? 'UPLOADER' : 'USER');
      document.getElementById('badge-primary').textContent = primary;

      const currentTitle = (Array.isArray(me.titles) && me.titles[0]) ? me.titles[0] : '';
      elSelTitle.value = currentTitle;
      document.getElementById('badge-secondary').textContent = currentTitle || '≈Ω√°dn√Ω titul';

      const uploads = me.stats?.uploads || 0;
      Array.from(elSelTitle.options).forEach(opt=>{
        const min = Number(opt.dataset.min||0); if (!min) return;
        opt.disabled = uploads < min;
        if (uploads < min && !opt.textContent.includes('(zamƒçeno)')) opt.textContent += ' (zamƒçeno)';
      });

      elSelVis.value = (me.visibility || 'private');

      const slug = me.slug || email.split('@')[0];
      elPubUrl.dataset.copy = `${location.origin}/u/${slug}`;
      elPubUrl.textContent  = `http://x/u/${slug}`;

      prevName.textContent = me.display_name || slug;
      prevSlug.textContent = '@' + slug;
      prevJoin.textContent = 'ƒålenem od ' + ddmmyyyy(me.joined_at || me.created_at);

      if (me.avatar_url){
        elAvatar.innerHTML = `<img src="${me.avatar_url}?ts=${Date.now()}" alt="avatar">`;
        prevAva.innerHTML  = `<img src="${me.avatar_url}?ts=${Date.now()}" alt="avatar" style="width:100%;height:100%;object-fit:cover">`;
      } else {
        const letter = (email||'?')[0].toUpperCase();
        elAvaLetter.textContent = letter;
        prevAva.innerHTML = `<span>${letter}</span>`;
      }

      // milestone r√°m
      try{
        const frameCls = App.computeMilestoneFrame(uploads);
        const frameEl = document.getElementById('avatarFrame'); if (frameCls) frameEl.classList.add('frame', frameCls);
      }catch{}
    }

    // ====== AVATAR (GCS signed URL) ======
    elAvatar.addEventListener('click', ()=> elInpAvatar.click());
    elInpAvatar.addEventListener('change', async ()=>{
      const f = elInpAvatar.files?.[0]; if(!f) return;
      if (!/^image\/(png|jpe?g)$/i.test(f.type)) { App.toast('Povoleny jsou PNG/JPEG','error'); return; }
      if (f.size > 2*1024*1024) { App.toast('Obr√°zek je vƒõt≈°√≠ ne≈æ 2 MB','error'); return; }

      const mime = f.type.toLowerCase();
      const ext  = mime.includes('png') ? 'png' : 'jpg';
      const path = `private/avatars/${encodeURIComponent(email)}.${ext}`;

      try{
        const r1 = await fetch('/upload/sign', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ path, contentType: mime })
        });
        const s = await r1.json(); if (!s.ok || !s.url) throw 0;

        const r2 = await fetch(s.url, { method:'PUT', headers:{'Content-Type': mime}, body: f });
        if (!r2.ok) throw 0;

        const avatarUrl = `${window.CLOUD_BASE}/${path}`;
        const r3 = await fetch(`/api/me/update?email=${encodeURIComponent(email)}`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ avatar_url: avatarUrl })
        });
        const j3 = await r3.json(); if (!r3.ok || !j3.ok) throw 0;

        // update LS (a.auth.profile) ‚Äì aby avatar dr≈æel i lok√°lnƒõ
        try{
          const auth = App.auth() || {};
          auth.profile = { ...(auth.profile||{}), avatar_url: avatarUrl };
          localStorage.setItem('animecloud_auth', JSON.stringify(auth));
        }catch{}

        elAvatar.innerHTML = `<img src="${avatarUrl}?t=${Date.now()}" alt="avatar">`;
        prevAva.innerHTML  = `<img src="${avatarUrl}?t=${Date.now()}" alt="avatar" style="width:100%;height:100%;object-fit:cover">`;
        App.toast('Avatar ulo≈æen','ok');
      }catch{
        App.toast('Ukl√°d√°n√≠ avataru selhalo','error');
      }finally{
        elInpAvatar.value = '';
      }
    });

    // ====== ULO≈ΩIT PROFIL (toasty vpravo) ======
    document.getElementById('btnSaveProfile').addEventListener('click', async ()=>{
      const nick  = elNick.value.trim();
      const title = elSelTitle.value || null;

      try{
        const r = await fetch(`/api/me/update?email=${encodeURIComponent(email)}`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ display_name: nick || null, titles: title ? [title] : [] })
        });
        const j = await r.json(); if(!r.ok || !j.ok) throw 0;

        const r2 = await fetch(`/api/me/visibility?email=${encodeURIComponent(email)}`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ visibility: elSelVis.value })
        });
        const j2 = await r2.json(); if(!r2.ok || !j2.ok) throw 0;

        document.getElementById('acc-nickname').textContent = nick || email;
        document.getElementById('badge-secondary').textContent = title || '≈Ω√°dn√Ω titul';

        // ulo≈æ do LS, a≈• to dr≈æ√≠ i v App.auth()
        try{
          const auth = App.auth() || {};
          auth.profile = { ...(auth.profile||{}), display_name: nick || email, titles: title ? [title] : [] };
          localStorage.setItem('animecloud_auth', JSON.stringify(auth));
        }catch{}

        App.toast('‚úÖ Profil ulo≈æen','ok');
      }catch{
        App.toast('‚ùå Ulo≈æen√≠ selhalo','error');
      }
    });

    // ====== Zobrazit ve≈ôejn√Ω profil ======
    document.getElementById('btnShowPublic').addEventListener('click', async ()=>{
      const r = await fetch(`/api/me?email=${encodeURIComponent(email)}`);
      const j = await r.json(); const slug = j?.me?.slug || email.split('@')[0];
      location.href = `/u/${slug}`;
    });

    // ====== Copy-to-clipboard ======
    document.querySelectorAll('.copyable').forEach(el=>{
      el.addEventListener('click', async ()=>{
        const txt = (el.dataset.copy || el.textContent || '').trim();
        try{ await navigator.clipboard.writeText(txt); App.toast('Zkop√≠rov√°no'); }
        catch{ App.toast('Nepoda≈ôilo se zkop√≠rovat','error'); }
      });
    });

    // ====== Modal: zmƒõna hesla ======
    const modal = document.getElementById('pwdModal');
    document.getElementById('btnChangePwd').addEventListener('click', ()=> modal.style.display='flex');
    document.getElementById('pwdCancel').addEventListener('click', ()=> modal.style.display='none');
    document.getElementById('pwdSubmit').addEventListener('click', async ()=>{
      const old = document.getElementById('pwdOld').value;
      const n1  = document.getElementById('pwdNew1').value;
      const n2  = document.getElementById('pwdNew2').value;
      if (!old || !n1 || !n2) { App.toast('Vypl≈à v≈°echna pole','error'); return; }
      if (n1 !== n2) { App.toast('Nov√° hesla se neshoduj√≠','error'); return; }
      try{
        const r = await fetch('/auth/change_password', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, old, new: n1 })
        });
        const j = await r.json(); if (!r.ok || !j.ok) throw 0;
        App.toast('Heslo zmƒõnƒõno','ok'); modal.style.display='none';
        document.getElementById('pwdOld').value='';
        document.getElementById('pwdNew1').value='';
        document.getElementById('pwdNew2').value='';
      }catch{
        App.toast('Zmƒõna hesla selhala','error');
      }
    });

    // GO
    loadMe();
  </script>
</body>
</html>
